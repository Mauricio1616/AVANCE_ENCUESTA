<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Malla Curricular Interactiva</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet">
        <link rel="stylesheet" href="style.css">
        <!-- Scripts de Firebase (Marcador para el Ingeniero) -->
        <script type="module">
        // -------------------------------------------------------------------------
        // ZONA DE INTEGRACI√ìN PARA EL INGENIERO DE SISTEMAS
        // -------------------------------------------------------------------------
        // Aqu√≠ se deben importar las librer√≠as de Firebase y configurar la conexi√≥n.
        // La funci√≥n window.saveSurveyToFirebase(data) es llamada al final de la encuesta.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCkhGGnoJpAJSs3YC55EzHj2ETGSCvK63w",
          authDomain: "psiconet-360.firebaseapp.com",
          projectId: "psiconet-360",
          storageBucket: "psiconet-360.appspot.com",
          messagingSenderId: "210998536370",
          appId: "1:210998536370:web:da23055d04f4491175c1ab"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Iniciar sesi√≥n an√≥nimo (recomendado para permitir escritura segura desde el cliente)
        signInAnonymously(auth).catch(err => console.warn('Auth error:', err));

        window.saveSurveyToFirebase = async (data) => {
          try {
            const docRef = await addDoc(collection(db, 'encuestas_estudiantes'), {
              ...data,
              timestamp: serverTimestamp()
            });
            console.log('Guardado en Firestore, id:', docRef.id);
            return true;
          } catch (err) {
            console.error('Error al guardar:', err);
            return false;
          }
        };

        // Cargar registros usando Web Worker
        window.registrosValidos = new Set();
        window.registrosCargados = false;
        
        fetch('datos.txt')
          .then(response => {
            if (!response.ok) throw new Error('No se pudo cargar datos.txt');
            return response.text();
          })
          .then(texto => {
            console.log('üì• Archivo cargado:', (texto.length / 1024 / 1024).toFixed(2), 'MB');
            
            const worker = new Worker('registros-worker.js');
            
            worker.onmessage = function(e) {
              const { success, cantidad, registros, tiempo } = e.data;
              
              if (!success) {
                console.error('‚ùå Error en Worker:', e.data.error);
                return;
              }
              
              // Cargar registros en el Set
              registros.forEach(r => window.registrosValidos.add(r));
              window.registrosCargados = true;
              
              console.log(`‚úÖ Se cargaron ${cantidad} registros en ${tiempo}ms`);
              
              // Disparar evento
              window.dispatchEvent(new CustomEvent('registrosCargados', {
                detail: { cantidad: cantidad }
              }));
              
              worker.terminate();
            };
            
            worker.onerror = function(err) {
              console.error('‚ùå Error en Worker:', err);
              window.registrosCargados = false;
            };
            
            worker.postMessage({
              action: 'cargarRegistros',
              texto: texto
            });
          })
          .catch(err => {
            console.error('‚ùå Error cargando datos.txt:', err);
            window.registrosValidos = new Set();
            window.registrosCargados = false;
          });
    </script>
    </head>
    <body
        class="bg-slate-50 text-slate-800 h-screen font-sans overflow-hidden relative w-full">

        <!-- VARIABLE GLOBAL PARA ALMACENAR DATOS -->
        <script>
        window.surveyData = {
            personal: {},
            malla: [],
            seccion2_cierre: {},
            seccion3: {},
            seccion4: {},
            seccion5: {}
        };
    </script>

        <!-- ================= VISTA 1: ENCUESTA INICIAL ================= -->
        <div id="section1-view"
            class="view-container fixed inset-0 z-[100] bg-slate-100 overflow-y-auto overflow-x-hidden">
            <div
                class="min-h-screen w-full flex flex-col items-center justify-start py-6 px-4 md:py-10">
                <div
                    class="w-full max-w-3xl bg-white rounded-xl shadow-xl border border-slate-200 overflow-hidden mb-10">
                    <div class="bg-blue-900 p-6 text-white relative">
                        <div
                            class="flex flex-col md:flex-row items-start md:items-center gap-4 mb-2">
                            <img src="img/Encabezado.png" alt="Logo"
                                class="h-16 w-auto object-contain bg-white rounded p-1 shadow-sm">
                            <div>
                                <h1
                                    class="text-xl md:text-2xl font-bold leading-tight">Encuesta
                                    para Estudiantes sobre Situaci√≥n Acad√©mica y
                                    Transici√≥n al Nuevo Curr√≠culo</h1>
                                <p
                                    class="text-blue-200 text-sm mt-1 font-medium">Carrera
                                    de Psicolog√≠a - UAGRM</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-5 md:p-8 space-y-6">
                        <div
                            class="bg-slate-50 p-5 rounded-lg border border-slate-200 text-sm space-y-4 text-slate-700">
                            <div><strong
                                    class="text-blue-900 block mb-1 text-base"><i
                                        class="fas fa-bullseye mr-2"></i>Objetivo</strong><p>Conocer
                                    tu situaci√≥n actual, tus percepciones sobre
                                    el proceso de transici√≥n curricular y tus
                                    preferencias para las medidas de
                                    adaptaci√≥n.</p></div>
                            <div><strong
                                    class="text-blue-900 block mb-1 text-base"><i
                                        class="fas fa-tasks mr-2"></i>Consigna</strong><p>Te
                                    invitamos a completar esta encuesta dirigida
                                    a estudiantes de la carrera de Psicolog√≠a de
                                    la UAGRM. Tus respuestas ser√°n de gran
                                    importancia para comprender la situaci√≥n
                                    acad√©mica actual y el impacto del proceso de
                                    transici√≥n al nuevo curr√≠culo.</p></div>
                            <div
                                class="pt-3 border-t border-slate-200 mt-2"><strong
                                    class="text-red-800 block mb-1 text-base"><i
                                        class="fas fa-file-contract mr-2"></i>Consentimiento
                                    informado</strong><p
                                    class="text-xs md:text-sm text-slate-600 leading-relaxed">La
                                    participaci√≥n en esta encuesta es
                                    voluntaria. <br><span
                                        class="font-semibold text-slate-800 mt-1 block">La
                                        informaci√≥n proporcionada ser√° utilizada
                                        exclusivamente con fines acad√©micos y de
                                        mejora institucional, garantizando la
                                        confidencialidad y el anonimato de las
                                        respuestas. Al continuar con el
                                        formulario, usted manifiesta su
                                        consentimiento para participar en la
                                        presente encuesta.</span></p></div>
                        </div>
                        <div class="space-y-6">
                            <div class="border-b border-blue-100 pb-2 mb-4"><h2
                                    class="text-lg md:text-xl font-bold text-blue-900">Secci√≥n
                                    1: Datos Generales / Situaci√≥n
                                    Actual</h2></div>
                            <form id="form-section1" class="space-y-6"
                                onsubmit="goToSection2(event)">
                                <!-- P1 -->
                                <div><label
                                        class="font-bold text-slate-800 mb-2 block">1.
                                        Nombre</label><input
                                        type="text" name="nombre" required
                                        class="survey-input"></div>
                                <!-- P2 -->
                                <div><label
                                        class="font-bold text-slate-800 mb-2 block">2.
                                        Apellidos</label><input
                                        type="text" name="Apellidos" required
                                        class="survey-input"></div>
                                <!-- P3 -->
                                <div><label
                                        class="font-bold text-slate-800 mb-2 block">3.
                                        CI-C√©dula de Identidad</label><input type="text"
                                        name="CI" required
                                        class="survey-input"></div>                
                                <!-- P4 -->
                                <div><label
                                        class="font-bold text-slate-800 mb-2 block">4.
                                        Registro Universitario</label><input
                                        type="number" name="registro" required
                                        id="input-registro"
                                        class="survey-input"
                                        placeholder="Ej: 200012345">
                                        <div id="error-registro" class="hidden mt-2 p-3 bg-red-100 border border-red-400 text-red-700 rounded text-sm flex items-center gap-2">
                                            <i class="fas fa-exclamation-circle"></i>
                                            <span>Usted no est√° registrado como estudiante de la carrera de Psicolog√≠a</span>
                                        </div>
                                </div>

                                <!-- NUEVA P5: A√ëO DE INGRESO -->
                                <div>
                                    <label class="font-bold text-slate-800 mb-2 block">5. A√±o de ingreso a la carrera:</label>
                                    <div class="flex flex-wrap gap-4 text-sm">
                                        <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded"><input type="radio" name="anio_ingreso" value="2021" class="accent-blue-900"> 2021</label>
                                        <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded"><input type="radio" name="anio_ingreso" value="2022" class="accent-blue-900"> 2022</label>
                                        <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded"><input type="radio" name="anio_ingreso" value="2023" class="accent-blue-900"> 2023</label>
                                        <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded"><input type="radio" name="anio_ingreso" value="2024" class="accent-blue-900"> 2024</label>
                                        <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded"><input type="radio" name="anio_ingreso" value="2025" class="accent-blue-900"> 2025</label>
                                        <label class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded">
                                            <input type="radio" name="anio_ingreso" value="Otro" id="anio_otro_radio" class="accent-blue-900"> Otro:
                                            <input type="text" name="anio_ingreso_otro" class="border-b border-slate-300 outline-none w-20 text-sm focus:border-blue-900 bg-transparent" onclick="document.getElementById('anio_otro_radio').checked = true;">
                                        </label>
                                    </div>
                                </div>

                                <!-- NUEVA P6: MODALIDAD DE INGRESO -->
                                <div>
                                    <label class="font-bold text-slate-800 mb-2 block">6. Modalidad de ingreso:</label>
                                    <div class="flex flex-wrap gap-4 text-sm">
                                        <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded"><input type="radio" name="modalidad_ingreso" value="PSA" class="accent-blue-900"> PSA</label>
                                        <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded"><input type="radio" name="modalidad_ingreso" value="CUP" class="accent-blue-900"> CUP</label>
                                        <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded"><input type="radio" name="modalidad_ingreso" value="Admisi√≥n especial" class="accent-blue-900"> Admisi√≥n especial</label>
                                        <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded"><input type="radio" name="modalidad_ingreso" value="Traslado" class="accent-blue-900"> Traslado</label>
                                        <label class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded">
                                            <input type="radio" name="modalidad_ingreso" value="Otra" id="mod_otra_radio" class="accent-blue-900"> Otra:
                                            <input type="text" name="modalidad_ingreso_otra" class="border-b border-slate-300 outline-none w-32 text-sm focus:border-blue-900 bg-transparent" onclick="document.getElementById('mod_otra_radio').checked = true;">
                                        </label>
                                    </div>
                                </div>

                                <!-- NUEVA P7: CU√ÅNDO TERMINAR -->
                                <div>
                                    <label class="font-bold text-slate-800 mb-2 block">7. Seg√∫n tu avance actual, ¬øcu√°ndo crees que podr√≠as terminar la carrera?</label>
                                    <div class="flex flex-col gap-2 text-sm">
                                        <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded w-fit"><input type="radio" name="tiempo_terminar" value="En 1 a√±o" class="accent-blue-900"> En 1 a√±o</label>
                                        <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded w-fit"><input type="radio" name="tiempo_terminar" value="En 2 a√±os" class="accent-blue-900"> En 2 a√±os</label>
                                        <label class="flex items-center gap-2 cursor-pointer p-2 hover:bg-slate-50 rounded w-fit"><input type="radio" name="tiempo_terminar" value="En 3 a√±os" class="accent-blue-900"> En 3 a√±os</label>
                                        <label class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded w-fit">
                                            <input type="radio" name="tiempo_terminar" value="Otro" id="tiempo_otro_radio" class="accent-blue-900"> otro:
                                            <input type="text" name="tiempo_terminar_otro" class="border-b border-slate-300 outline-none w-40 text-sm focus:border-blue-900 bg-transparent" onclick="document.getElementById('tiempo_otro_radio').checked = true;">
                                        </label>
                                    </div>
                                </div>

                                <!-- P8 (ANTES 5) -->
                                <div><label
                                        class="font-bold text-slate-800 mb-2 block">8.
                                        Celular</label><input type="tel"
                                        name="celular" required
                                        class="survey-input"></div>
                                
                                <!-- P9 (ANTES 6) -->
                                <div><label
                                        class="font-bold text-slate-800 mb-2 block">9.
                                        Correo Electr√≥nico</label><input
                                        type="email" name="correo" required
                                        class="survey-input"></div>
                                
                                <!-- P10 (ANTES 7) -->
                                <div><label
                                        class="font-bold text-slate-800 mb-2 block">10.
                                        En qu√© semestre est√°s actualmente (marca uno solo si estas nivelado en un semestre y no debes materias de otro semestre. Si tienes materias en otros semestres, Marca las opciones necesarias)</label>
                                    <div
                                        class="grid grid-cols-2 md:grid-cols-5 gap-2 text-sm">
                                        <label
                                            class="p-2 border rounded hover:bg-blue-50 cursor-pointer flex gap-2"><input
                                                type="checkbox" name="semestre"
                                                value="1er Semestre">
                                            1er</label>
                                        <label
                                            class="p-2 border rounded hover:bg-blue-50 cursor-pointer flex gap-2"><input
                                                type="checkbox" name="semestre"
                                                value="2do Semestre">
                                            2do</label>
                                        <label
                                            class="p-2 border rounded hover:bg-blue-50 cursor-pointer flex gap-2"><input
                                                type="checkbox" name="semestre"
                                                value="3er Semestre">
                                            3er</label>
                                        <label
                                            class="p-2 border rounded hover:bg-blue-50 cursor-pointer flex gap-2"><input
                                                type="checkbox" name="semestre"
                                                value="4to Semestre">
                                            4to</label>
                                        <label
                                            class="p-2 border rounded hover:bg-blue-50 cursor-pointer flex gap-2"><input
                                                type="checkbox" name="semestre"
                                                value="5to Semestre">
                                            5to</label>
                                        <label
                                            class="p-2 border rounded hover:bg-blue-50 cursor-pointer flex gap-2"><input
                                                type="checkbox" name="semestre"
                                                value="6to Semestre">
                                            6to</label>
                                        <label
                                            class="p-2 border rounded hover:bg-blue-50 cursor-pointer flex gap-2"><input
                                                type="checkbox" name="semestre"
                                                value="7mo Semestre">
                                            7mo</label>
                                        <label
                                            class="p-2 border rounded hover:bg-blue-50 cursor-pointer flex gap-2"><input
                                                type="checkbox" name="semestre"
                                                value="8vo Semestre">
                                            8vo</label>
                                        <label
                                            class="p-2 border rounded hover:bg-blue-50 cursor-pointer flex gap-2"><input
                                                type="checkbox" name="semestre"
                                                value="9no Semestre">
                                            9no</label>
                                        <label
                                            class="p-2 border rounded hover:bg-blue-50 cursor-pointer flex gap-2"><input
                                                type="checkbox" name="semestre"
                                                value="10mo Semestre">
                                            10mo</label>
                                    </div>
                                </div>
                                
                                <!-- P11 (ANTES 8) -->
                                <div><label
                                        class="font-bold text-slate-800 mb-2 block">11.
                                        Carga acad√©mica registrada este
                                        semestre:</label>
                                        <label
                                        class="text-slate-800 mb-2 block">
                                        N√∫mero de materias inscritas: (Indicar√° aqu√≠ un n√∫mero no se permite letras)</label>
                                        <input type="number"
                                        name="carga_academica" required
                                        class="survey-input"
                                        placeholder="N√∫mero de materias"></div>

                                <!-- NUEVA P12: MATERIAS APROBADAS -->
                                <div>
                                    <label class="font-bold text-slate-800 mb-2 block">12. ¬øCu√°ntas materias has aprobado en total en todo tu recorrido acad√©mico? (coloca un n√∫mero)</label>
                                    <input type="number" name="materias_aprobadas" class="survey-input" placeholder="Ej: 25">
                                </div>

                                <!-- NUEVA P13: MATERIAS REPROBADAS -->
                                <div>
                                    <label class="font-bold text-slate-800 mb-2 block">13. ¬øCu√°ntas materias has reprobado? (coloca un n√∫mero)</label>
                                    <input type="number" name="materias_reprobadas" class="survey-input" placeholder="Ej: 2">
                                </div>

                                <!-- NUEVA P14: REPETIDO MATERIA (TAG INPUT) -->
                                <div>
                                    <label class="font-bold text-slate-800 mb-2 block">14. ¬øHas repetido alguna materia por tercera vez o m√°s?</label>
                                    <div class="flex items-center gap-4 mb-3">
                                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="repetido_materia" value="S√≠" class="accent-blue-900" onclick="document.getElementById('container-repitencia').classList.remove('hidden')"> S√≠</label>
                                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="repetido_materia" value="No" class="accent-blue-900" onclick="document.getElementById('container-repitencia').classList.add('hidden')"> No</label>
                                    </div>
                                    <div id="container-repitencia" class="hidden mt-2 p-4 bg-slate-50 border border-slate-200 rounded-lg animate-fade-in">
                                        <label class="block text-sm font-bold text-slate-700 mb-1">Cual o Cuales</label>
                                        <p class="text-xs text-slate-500 mb-2">Escribe el nombre de la materia y presiona <span class="font-bold">coma ( , )</span> para agregarla.</p>
                                        
                                        <!-- Container de Tags -->
                                        <div id="tags-container-q14" class="flex flex-wrap gap-2 mb-2"></div>
                                        
                                        <!-- Input Visual con Datalist para sugerencias -->
                                        <input type="text" 
                                               id="input-q14"
                                               class="survey-input text-sm" 
                                               placeholder="Escribe materia y pon coma..."
                                               list="materias-list">
                                        <p id="error-q14" class="text-xs text-red-600 mt-1 hidden font-bold"></p>
                                        
                                        <!-- Input Oculto Real (El que se env√≠a) -->
                                        <input type="hidden" name="materias_repetidas_nombres" id="hidden-q14">
                                    </div>
                                </div>

                                <!-- NUEVA P15: MATERIAS DIFICULTAD (TAG INPUT) -->
                                <div>
                                    <label class="font-bold text-slate-800 mb-2 block">15. ¬øEn qu√© materias has tenido m√°s dificultad?</label>
                                    <label class="text-slate-600 mb-1 block text-sm">Escribe el nombre de la materia y presiona <span class="font-bold">coma ( , )</span> para agregarla.</label>
                                    
                                    <!-- Container de Tags -->
                                    <div id="tags-container-q15" class="flex flex-wrap gap-2 mb-2"></div>
                                    
                                    <!-- Input Visual con Datalist para sugerencias -->
                                    <input type="text" 
                                           id="input-q15"
                                           class="survey-input text-sm" 
                                           placeholder="Escribe materia y pon coma..."
                                           list="materias-list">
                                    <p id="error-q15" class="text-xs text-red-600 mt-1 hidden font-bold"></p>
                                    
                                    <!-- Input Oculto Real (El que se env√≠a) -->
                                    <input type="hidden" name="materias_dificultad" id="hidden-q15">
                                </div>
                                
                                <!-- P16 (ANTES 9) -->
                                <div>
                                    <label
                                        class="font-bold text-slate-800 mb-2 block">16.
                                        ¬øTrabajas mientras estudias?</label>
                                        <label
                                        class="text-slate-800 mb-2 block">(Solo puede escoger S√≠ o No, no ambas)</label>
                                        <div
                                        class="flex gap-4"><label
                                            class="flex gap-2 cursor-pointer"><input
                                                type="radio" name="trabaja"
                                                value="S√≠" required>
                                            S√≠</label><label
                                            class="flex gap-2 cursor-pointer"><input
                                                type="radio" name="trabaja"
                                                value="No">
                                            No</label></div></div>
                                
                                <!-- P17 (ANTES 10) -->
                                <div><label
                                        class="font-bold text-slate-800 mb-2 block">17.
                                        ¬øCu√°ntas horas al d√≠a puedes dedicar
                                        realmente al estudio?</label>
                                        <label
                                        class="text-slate-800 mb-2 block">(Aqu√≠ indicar√° un n√∫mero, no se permite letras)</label>
                                        
                                        <input
                                        type="number" name="horas_estudio"
                                        required class="survey-input"></div>
                                
                                <!-- P18 (ANTES 11) -->
                                <div><label
                                        class="font-bold text-slate-800 mb-2 block">18.
                                        Estado general de avance
                                        acad√©mico:</label>
                                    <div class="space-y-2">
                                        <label class="block"><input type="radio"
                                                name="avance" value="Voy al d√≠a"
                                                required> Voy al d√≠a</label>
                                        <label class="block"><input type="radio"
                                                name="avance"
                                                value="Ligeramente atrasado(a)">
                                            Ligeramente atrasado(a)</label>
                                        <label class="block"><input type="radio"
                                                name="avance"
                                                value="Atraso moderado"> Atraso
                                            moderado</label>
                                        <label class="block"><input type="radio"
                                                name="avance"
                                                value="Atraso significativo">
                                            Atraso significativo</label>
                                    </div>
                                </div>
                                <div class="pt-6 border-t flex justify-end">
                                    <button type="submit"
                                        class="bg-red-900 text-white font-bold py-3 px-6 rounded-lg shadow hover:bg-red-800 transition">Continuar
                                        a Secci√≥n 2.- Avance Acad√©mico <i
                                            class="fas fa-arrow-right ml-2"></i></button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= VISTA 2: MALLA INTERACTIVA ================= -->
        <div id="section2-app-view"
            class="hidden h-screen w-full flex flex-col fade-in relative overflow-hidden">
            <header
                class="bg-white border-b border-slate-200 shadow-sm z-10 p-3 shrink-0">
                <div
                    class="max-w-[95%] mx-auto flex flex-col xl:flex-row justify-between items-center gap-3">
                    <div
                        class="flex items-center justify-between w-full xl:w-auto">
                        <h1
                            class="text-lg font-bold text-slate-800 flex items-center gap-2 select-none">
                            <img src="img/Encabezado.png" alt="Logo"
                                class="h-10 w-auto object-contain">
                            <span
                                class="bg-red-900 text-white text-xs px-2 py-1 rounded shadow-sm shrink-0">PSI</span>
                            <span class="truncate">Secci√≥n 2.- Avance
                                Acad√©mico</span>
                        </h1>
                    </div>
                    <!-- Controles -->
                    <div
                        class="flex items-center gap-2 bg-slate-100 p-1 rounded-lg overflow-x-auto max-w-full no-scrollbar shadow-inner">
                        <button onclick="setTool('aprobado')" id="btn-aprobado"
                            class="tool-btn flex items-center gap-2 px-3 py-1.5 rounded-md transition-all font-medium text-xs whitespace-nowrap"><div
                                class="w-2.5 h-2.5 rounded-full bg-green-600"></div>
                            Aprobado</button>
                        <button onclick="setTool('reprobado')"
                            id="btn-reprobado"
                            class="tool-btn flex items-center gap-2 px-3 py-1.5 rounded-md transition-all font-medium text-xs whitespace-nowrap"><div
                                class="w-2.5 h-2.5 rounded-full bg-red-600"></div>
                            Reprobado</button>
                        <button onclick="setTool('levantamiento')"
                            id="btn-levantamiento"
                            class="tool-btn flex items-center gap-2 px-3 py-1.5 rounded-md transition-all font-medium text-xs whitespace-nowrap"><div
                                class="w-2.5 h-2.5 rounded-full bg-blue-500"></div>
                            Levantamiento</button>
                        <button onclick="setTool('pendiente')"
                            id="btn-pendiente"
                            class="tool-btn flex items-center gap-2 px-3 py-1.5 rounded-md transition-all font-medium text-xs whitespace-nowrap"><div
                                class="w-2.5 h-2.5 rounded-full border border-slate-400"></div>
                            Limpiar</button>
                    </div>

                    <div
                        class="flex items-center gap-4 w-full xl:w-auto justify-end">
                        <div class="flex flex-col items-end min-w-[120px]">
                            <div
                                class="text-xs text-slate-500 whitespace-nowrap flex justify-between w-full mb-1">
                                <span>Avance Global</span>
                                <span id="progress-text"
                                    class="font-bold text-blue-900">0%</span>
                            </div>
                            <div
                                class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
                                <div id="progress-bar"
                                    class="h-full bg-blue-900 w-0 rounded-full"></div>
                            </div>
                        </div>
                        <!-- Bot√≥n Reset Desktop -->
                        <button onclick="confirmReset()"
                            class="hidden xl:flex items-center gap-1 text-slate-400 hover:text-red-800 text-xs transition-colors px-2 py-1 hover:bg-red-50 rounded"
                            title="Borrar todo el progreso">
                            <i class="fas fa-trash-alt"></i> Reset
                        </button>
                    </div>
                </div>
            </header>

            <main id="malla-container"
                class="flex-1 w-full overflow-x-auto overflow-y-auto hide-scroll bg-slate-50 p-6 relative mb-16 cursor-grab active:cursor-grabbing">
                <div class="min-w-max mx-auto space-y-8 pb-10">
                    <div id="semesters-container" class="flex gap-4 pb-4"></div>
                    <div class="border-t-2 border-slate-200 pt-6 mt-4">
                        <div class="flex flex-col gap-4 pl-0 md:pl-4">
                            <div class="flex gap-3 items-center"><div
                                    class="w-24 text-right text-xs font-bold text-slate-400 uppercase mr-2">Electivas</div><div
                                    id="electivas-row"
                                    class="flex gap-3"></div></div>
                            <div class="flex gap-3 items-center"><div
                                    class="w-24 text-right text-xs font-bold text-slate-400 uppercase mr-2">Talleres</div><div
                                    id="talleres-row"
                                    class="flex gap-3"></div></div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Bot√≥n Flotante para Continuar -->
            <div
                class="absolute bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur border-t border-slate-200 flex justify-center z-20">
                <button onclick="goToSection2Q10()"
                    class="bg-red-900 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-red-800 transition transform hover:scale-105 flex items-center gap-2 animate-bounce">
                    Confirmar Avance y Continuar <i
                        class="fas fa-check-circle"></i>
                </button>
            </div>
        </div>

        <!-- ================= VISTA 3: PREGUNTA 19 (ANTES 12 - CIERRE SECCI√ìN 2) ================= -->
        <div id="section2-q10-view"
            class="hidden view-container fixed inset-0 z-[100] bg-slate-100 overflow-y-auto">
            <div
                class="min-h-screen w-full flex flex-col items-center justify-center p-4">
                <div
                    class="w-full max-w-2xl bg-white rounded-xl shadow-xl border border-slate-200 overflow-hidden fade-in">
                    <div class="bg-blue-900 p-4 text-white"><h2
                            class="text-xl font-bold">Cierre Secci√≥n
                            2</h2></div>
                    <div class="p-6">
                        <form id="form-q10" onsubmit="goToSection3(event)"
                            class="space-y-6">
                            <div>
                                <label
                                    class="text-lg font-bold text-slate-900 mb-4 block">19.
                                    ¬øEstas materias afectan tu avance hacia el
                                    nuevo curr√≠culo?</label>
                                <div class="space-y-3">
                                    <label
                                        class="flex items-center gap-3 p-3 border rounded-lg hover:bg-slate-50 cursor-pointer"><input
                                            type="radio" name="q10" value="Si"
                                            required
                                            class="accent-blue-900 w-5 h-5">
                                        S√≠</label>
                                    <label
                                        class="flex items-center gap-3 p-3 border rounded-lg hover:bg-slate-50 cursor-pointer"><input
                                            type="radio" name="q10" value="No"
                                            class="accent-blue-900 w-5 h-5">
                                        No</label>
                                    <label
                                        class="flex items-center gap-3 p-3 border rounded-lg hover:bg-slate-50 cursor-pointer"><input
                                            type="radio" name="q10"
                                            value="No se"
                                            class="accent-blue-900 w-5 h-5"> No
                                        s√©</label>
                                    <label
                                        class="flex flex-col gap-2 p-3 border rounded-lg hover:bg-slate-50 cursor-pointer">
                                        <div
                                            class="flex items-center gap-3"><input
                                                type="radio" name="q10"
                                                value="Depende" id="q10-depende"
                                                class="accent-blue-900 w-5 h-5">
                                            Depende (explica):</div>
                                        <input type="text" id="q10-text"
                                            class="ml-8 border-b border-slate-300 outline-none focus:border-blue-900 w-[80%]"
                                            placeholder="Escribe tu explicaci√≥n..."
                                            disabled>
                                    </label>
                                </div>
                            </div>
                            <div class="flex justify-end pt-4"><button
                                    type="submit"
                                    class="bg-red-900 text-white font-bold py-3 px-8 rounded-lg shadow hover:bg-red-800 transition">Continuar
                                    a Secci√≥n 3 <i
                                        class="fas fa-arrow-right ml-2"></i></button></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= VISTA 4: SECCI√ìN 3 (EXPECTATIVAS) ================= -->
        <div id="section3-view"
            class="hidden view-container fixed inset-0 z-[100] bg-slate-100 overflow-y-auto">
            <div
                class="min-h-screen w-full flex flex-col items-center justify-start py-10 px-4">
                <div
                    class="w-full max-w-3xl bg-white rounded-xl shadow-xl border border-slate-200 overflow-hidden fade-in">
                    <div class="bg-blue-900 p-6 text-white"><h2
                            class="text-xl font-bold">Secci√≥n 3: Expectativas
                            frente al Nuevo Curr√≠culo</h2></div>
                    <div class="p-8">
                        <form id="form-section3" onsubmit="goToSection4(event)"
                            class="space-y-8">
                            <!-- P20 (ANTES 13) -->
                            <div>
                                <label
                                    class="text-lg font-bold text-slate-900 mb-4 block">20.
                                    ¬øC√≥mo te sientes respecto a la
                                    implementaci√≥n del nuevo curr√≠culo?</label>
                                <div class="space-y-2 text-sm md:text-base">
                                    <label
                                        class="flex items-start gap-3 p-2 hover:bg-slate-50 rounded"><input
                                            type="radio" name="q11"
                                            value="Motivado" required
                                            class="mt-1 accent-blue-900">
                                        <div><strong>Motivado(a):</strong> lo
                                            veo como una oportunidad para
                                            mejorar la formaci√≥n.</div></label>
                                    <label
                                        class="flex items-start gap-3 p-2 hover:bg-slate-50 rounded"><input
                                            type="radio" name="q11"
                                            value="Cauteloso"
                                            class="mt-1 accent-blue-900">
                                        <div><strong>Cauteloso(a):</strong>
                                            prefiero observar c√≥mo se desarrolla
                                            antes de opinar.</div></label>
                                    <label
                                        class="flex items-start gap-3 p-2 hover:bg-slate-50 rounded"><input
                                            type="radio" name="q11"
                                            value="Preocupado"
                                            class="mt-1 accent-blue-900">
                                        <div><strong>Preocupado(a):</strong>
                                            temo que afecte mi avance
                                            acad√©mico.</div></label>
                                    <label
                                        class="flex items-start gap-3 p-2 hover:bg-slate-50 rounded"><input
                                            type="radio" name="q11"
                                            value="Indiferente"
                                            class="mt-1 accent-blue-900">
                                        <div><strong>Indiferente:</strong> no
                                            creo que cambie mucho mi
                                            situaci√≥n.</div></label>
                                    <label
                                        class="flex items-start gap-3 p-2 hover:bg-slate-50 rounded"><input
                                            type="radio" name="q11"
                                            value="Confundido"
                                            class="mt-1 accent-blue-900">
                                        <div><strong>Confundido(a):</strong> a√∫n
                                            no comprendo bien el nuevo
                                            plan.</div></label>
                                </div>
                            </div>
                            <!-- P21 (ANTES 14) -->
                            <div class="border-t pt-6">
                                <label
                                    class="text-lg font-bold text-slate-900 mb-4 block">21.
                                    ¬øQu√© crees que aportar√° el nuevo
                                    curr√≠culo?</label>
                                <div class="space-y-2 text-sm md:text-base">
                                    <label
                                        class="block p-2 hover:bg-slate-50 rounded"><input
                                            type="radio" name="q12"
                                            value="Organizacion" required
                                            class="accent-blue-900 mr-2"> Mejor
                                        organizaci√≥n del avance
                                        acad√©mico</label>
                                    <label
                                        class="block p-2 hover:bg-slate-50 rounded"><input
                                            type="radio" name="q12"
                                            value="Secuencias"
                                            class="accent-blue-900 mr-2">
                                        Secuencias m√°s claras y l√≥gicas de
                                        contenido</label>
                                    <label
                                        class="block p-2 hover:bg-slate-50 rounded"><input
                                            type="radio" name="q12"
                                            value="Flexibilidad"
                                            class="accent-blue-900 mr-2"> Mayor
                                        flexibilidad</label>
                                    <label
                                        class="block p-2 hover:bg-slate-50 rounded"><input
                                            type="radio" name="q12"
                                            value="Claridad"
                                            class="accent-blue-900 mr-2">
                                        Claridad en perfiles y
                                        competencias</label>
                                    <label
                                        class="block p-2 hover:bg-slate-50 rounded"><input
                                            type="radio" name="q12"
                                            value="Ninguna"
                                            class="accent-blue-900 mr-2">
                                        Ninguna de las anteriores</label>
                                    <label
                                        class="block p-2 hover:bg-slate-50 rounded">
                                        <input type="radio" name="q12"
                                            value="Otra" id="q12-otra"
                                            class="accent-blue-900 mr-2"> Otra
                                        opini√≥n:
                                        <input type="text" id="q12-text"
                                            class="ml-2 border-b border-slate-300 outline-none focus:border-blue-900 w-1/2"
                                            disabled>
                                    </label>
                                </div>
                            </div>
                            <div class="flex justify-end pt-4"><button
                                    type="submit"
                                    class="bg-red-900 text-white font-bold py-3 px-8 rounded-lg shadow hover:bg-red-800 transition">Continuar
                                    a Secci√≥n 4 <i
                                        class="fas fa-arrow-right ml-2"></i></button></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= VISTA 5: SECCI√ìN 4 (MEDIDAS) ================= -->
        <div id="section4-view"
            class="hidden view-container fixed inset-0 z-[100] bg-slate-100 overflow-y-auto">
            <div
                class="min-h-screen w-full flex flex-col items-center justify-start py-10 px-4">
                <div
                    class="w-full max-w-3xl bg-white rounded-xl shadow-xl border border-slate-200 overflow-hidden fade-in">
                    <div class="bg-blue-900 p-6 text-white"><h2
                            class="text-xl font-bold">Secci√≥n 4: Medidas de
                            Transici√≥n Preferidas</h2></div>
                    <div class="p-8">
                        <form id="form-section4" onsubmit="goToSection5(event)"
                            class="space-y-8">
                            <!-- P22 (ANTES 15) -->
                            <div>
                                <label
                                    class="text-lg font-bold text-slate-900 mb-4 block">22.
                                    Medidas que consideras √∫tiles para tu avance
                                    (selecci√≥n m√∫ltiple):</label>
                                <div class="space-y-2 text-sm md:text-base"
                                    id="q13-container">
                                    <label
                                        class="block p-2 hover:bg-slate-50 rounded cursor-pointer"><input
                                            type="checkbox" name="q13"
                                            value="Cursos de verano intensivos"
                                            class="accent-blue-900 mr-2 q13-check">
                                        Cursos de verano intensivos (para
                                        adelantar o recuperar)</label>
                                    <label
                                        class="block p-2 hover:bg-slate-50 rounded cursor-pointer"><input
                                            type="checkbox" name="q13"
                                            value="Semestres de igualaci√≥n sin prerrequisitos"
                                            class="accent-blue-900 mr-2 q13-check">
                                        Semestres de igualaci√≥n sin
                                        prerrequisitos</label>
                                    <label
                                        class="block p-2 hover:bg-slate-50 rounded cursor-pointer"><input
                                            type="checkbox" name="q13"
                                            value="Cursos especiales de nivelaci√≥n en el semestre"
                                            class="accent-blue-900 mr-2 q13-check">
                                        Cursos especiales de nivelaci√≥n en el
                                        semestre</label>
                                    <label
                                        class="block p-2 hover:bg-slate-50 rounded cursor-pointer"><input
                                            type="checkbox" name="q13"
                                            value="Tutor√≠as acad√©micas personalizadas"
                                            class="accent-blue-900 mr-2 q13-check">
                                        Tutor√≠as acad√©micas
                                        personalizadas</label>
                                    <label
                                        class="block p-2 hover:bg-slate-50 rounded cursor-pointer"><input
                                            type="checkbox" name="q13"
                                            value="Adaptaci√≥n flexible de prerrequisitos por √∫nica vez"
                                            class="accent-blue-900 mr-2 q13-check">
                                        Adaptaci√≥n flexible de prerrequisitos
                                        por √∫nica vez</label>
                                    <label
                                        class="block p-2 hover:bg-slate-50 rounded cursor-pointer">
                                        <input type="checkbox" name="q13"
                                            value="Otros" id="q13-otros"
                                            class="accent-blue-900 mr-2 q13-check">
                                        Otros:
                                        <input type="text" id="q13-text"
                                            class="ml-2 border-b border-slate-300 outline-none focus:border-blue-900 w-1/2"
                                            disabled>
                                    </label>
                                </div>
                            </div>
                            <!-- P23 (ANTES 16) -->
                            <div class="border-t pt-6">
                                <label
                                    class="text-lg font-bold text-slate-900 mb-2 block">23.
                                    De esas medidas que consideras √∫tiles para
                                    tu avance cual ser√≠a Prioridad absoluta
                                    (elige solo una):</label>
                                <p class="text-sm text-slate-500 mb-4">Se
                                    mostrar√°n las opciones que seleccionaste
                                    arriba.</p>
                                <div id="q14-options"
                                    class="space-y-2 text-sm md:text-base bg-slate-50 p-4 rounded-lg border border-slate-200 min-h-[50px]">
                                    <p class="text-slate-400 italic">Selecciona
                                        opciones en la pregunta 22 primero.</p>
                                </div>
                            </div>
                            <div class="flex justify-end pt-4"><button
                                    type="submit"
                                    class="bg-red-900 text-white font-bold py-3 px-8 rounded-lg shadow hover:bg-red-800 transition">Continuar
                                    a Secci√≥n 5 <i
                                        class="fas fa-arrow-right ml-2"></i></button></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= VISTA 6: SECCI√ìN 5 (FINAL) ================= -->
        <div id="section5-view"
            class="hidden view-container fixed inset-0 z-[100] bg-slate-100 overflow-y-auto">
            <div
                class="min-h-screen w-full flex flex-col items-center justify-center p-4">
                <div
                    class="w-full max-w-2xl bg-white rounded-xl shadow-xl border border-slate-200 overflow-hidden fade-in">
                    <div class="bg-blue-900 p-6 text-white"><h2
                            class="text-xl font-bold">Secci√≥n 5: Comentarios
                            Finales</h2></div>
                    <div class="p-8">
                        <form id="form-section5" onsubmit="submitFinal(event)"
                            class="space-y-6">
                            <div>
                                <label
                                    class="text-lg font-bold text-slate-900 mb-2 block">24.
                                    Propuesta para mejorar la transici√≥n
                                    (respuesta abierta):</label>
                                <textarea name="propuesta" required
                                    class="w-full border border-slate-300 rounded-lg p-3 h-32 focus:border-blue-900 outline-none resize-none"
                                    placeholder="Escribe tu propuesta aqu√≠..."></textarea>
                            </div>
                            <div class="flex justify-end pt-4"><button
                                    type="submit"
                                    class="bg-green-600 text-white font-bold py-3 px-10 rounded-lg shadow hover:bg-green-700 transition transform hover:scale-105">Finalizar
                                    Encuesta <i
                                        class="fas fa-check ml-2"></i></button></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= VISTA 7: GRACIAS ================= -->
        <div id="thank-you-view"
            class="hidden view-container fixed inset-0 z-[100] bg-slate-900/90 flex items-center justify-center">
            <div
                class="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-md mx-4 fade-in transform scale-100">
                <!-- Spinner -->
                <div id="loading-spinner"
                    class="hidden flex flex-col items-center">
                    <i
                        class="fas fa-circle-notch fa-spin text-4xl text-blue-900 mb-4"></i>
                    <p class="text-slate-600 font-medium">Enviando
                        respuestas...</p>
                </div>
                <!-- √âxito -->
                <div id="success-msg" class="hidden">
                    <div
                        class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6"><i
                            class="fas fa-check text-4xl text-green-600"></i></div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">¬°Muchas
                        Gracias!</h2>
                    <p class="text-slate-600 mb-6">Tus respuestas han sido
                        registradas exitosamente. Tu opini√≥n es valiosa para la
                        carrera de Psicolog√≠a.</p>
                    <button onclick="location.reload()"
                        class="text-blue-900 font-semibold hover:underline">Volver
                        al inicio</button>
                </div>
            </div>
        </div>

        <!-- Modal Editar (Mismo de antes) -->
        <div id="edit-modal"
            class="fixed inset-0 bg-slate-900/50 backdrop-blur-[2px] hidden items-center justify-center z-[150]">
            <div
                class="bg-white p-6 rounded-xl shadow-2xl w-96 transform scale-95 transition-all"
                id="modal-content">
                <h3 class="text-lg font-bold text-slate-800 mb-1">Editar
                    Materia</h3>
                <input type="text" id="edit-input"
                    class="w-full border p-2 rounded mb-4 mt-2">
                <div class="flex justify-end gap-2">
                    <button onclick="closeModal()"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded">Cancelar</button>
                    <button onclick="saveEdit()"
                        class="px-6 py-2 bg-blue-900 text-white rounded">Guardar</button>
                </div>
            </div>
        </div>

        <!-- Modal Confirmar Reset -->
        <div id="reset-modal"
            class="fixed inset-0 bg-slate-900/50 backdrop-blur-[2px] hidden items-center justify-center z-[150]">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-80 text-center">
                <div
                    class="w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-3 text-xl"><i
                        class="fas fa-exclamation-triangle"></i></div>
                <h3 class="text-lg font-bold text-slate-800 mb-2">¬øBorrar
                    todo?</h3>
                <p class="text-sm text-slate-500 mb-6">Se perder√° todo el
                    progreso.</p>
                <div class="flex gap-2 justify-center">
                    <button onclick="closeResetModal()"
                        class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg">Cancelar</button>
                    <button onclick="performReset()"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg">S√≠,
                        borrar</button>
                </div>
            </div>
        </div>
        
        <!-- DATALIST PARA SUGERENCIAS -->
        <datalist id="materias-list"></datalist>

        <script src="script.js"></script>
        
        <!-- SCRIPT PARA LOGICA DE TAGS (MATERIAS.TXT) -->
        <script>
            window.addEventListener('load', () => {
                // 1. Cargar materias.txt
                const validSubjectsSet = new Set();
                const datalist = document.getElementById('materias-list');
                
                fetch('materias.txt')
                    .then(r => r.ok ? r.text() : Promise.reject('No materias.txt'))
                    .then(text => {
                        const lines = text.split('\n');
                        lines.forEach(line => {
                            const subj = line.trim();
                            if(subj) {
                                validSubjectsSet.add(subj.toLowerCase()); // Para validaci√≥n insensible a may√∫sculas
                                // Poblar datalist para sugerencias visuales
                                const opt = document.createElement('option');
                                opt.value = subj; // Mantener formato original visual
                                datalist.appendChild(opt);
                            }
                        });
                        console.log(`üìö ${validSubjectsSet.size} materias cargadas para validaci√≥n.`);
                        
                        // Inicializar l√≥gica de inputs una vez cargado
                        setupTagInput('input-q14', 'tags-container-q14', 'hidden-q14', 'error-q14', validSubjectsSet, lines);
                        setupTagInput('input-q15', 'tags-container-q15', 'hidden-q15', 'error-q15', validSubjectsSet, lines);
                    })
                    .catch(err => console.warn('No se pudo cargar materias.txt para validaci√≥n', err));

                // Funci√≥n configuraci√≥n de Input de Tags
                function setupTagInput(inputId, containerId, hiddenId, errorId, validSet, originalList) {
                    const input = document.getElementById(inputId);
                    const container = document.getElementById(containerId);
                    const hidden = document.getElementById(hiddenId);
                    const error = document.getElementById(errorId);
                    
                    if(!input || !container || !hidden) return;

                    let tags = [];

                    // Evento al escribir
                    input.addEventListener('keyup', (e) => {
                        // Detectar Coma (,)
                        if (e.key === ',' || e.code === 'Comma') {
                            const val = input.value.replace(',', '').trim(); // Limpiar coma
                            if(val) {
                                validateAndAddTag(val);
                            }
                            input.value = ''; // Limpiar input siempre al dar coma
                        }
                    });
                    
                    // Validar tambi√©n al perder foco si hay texto
                    input.addEventListener('blur', () => {
                        const val = input.value.replace(',', '').trim();
                        if(val) {
                            validateAndAddTag(val);
                            input.value = '';
                        }
                    });

                    function validateAndAddTag(text) {
                        // Validar contra el Set
                        if (validSet.has(text.toLowerCase())) {
                            // Buscar el nombre con formato original (May√∫sculas/Min√∫sculas correctas)
                            const originalName = originalList.find(s => s.toLowerCase() === text.toLowerCase()) || text;
                            
                            // Evitar duplicados
                            if(!tags.includes(originalName)) {
                                tags.push(originalName);
                                renderTags();
                                error.classList.add('hidden');
                            }
                        } else {
                            // Mostrar error
                            error.textContent = `‚ùå "${text}" no es una materia v√°lida.`;
                            error.classList.remove('hidden');
                            // Ocultar error despu√©s de 3 seg
                            setTimeout(() => error.classList.add('hidden'), 3000);
                        }
                    }

                    function renderTags() {
                        container.innerHTML = '';
                        tags.forEach((tag, index) => {
                            const badge = document.createElement('span');
                            badge.className = 'inline-flex items-center gap-1 bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full border border-blue-200 animate-fade-in';
                            badge.innerHTML = `
                                ${tag}
                                <button type="button" class="text-blue-400 hover:text-red-500 font-bold ml-1 focus:outline-none" data-index="${index}">&times;</button>
                            `;
                            // Listener para borrar
                            badge.querySelector('button').addEventListener('click', (e) => {
                                e.stopPropagation(); // Evitar triggers raros
                                removeTag(index);
                            });
                            container.appendChild(badge);
                        });
                        
                        // Actualizar input oculto para el formulario
                        hidden.value = tags.join(', ');
                    }

                    function removeTag(index) {
                        tags.splice(index, 1);
                        renderTags();
                    }
                }
            });
        </script>
    </body>
</html>
