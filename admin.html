<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin - Encuesta Psicolog√≠a</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet">

        <!-- Firebase SDKs -->
        <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIGURACI√ìN (A ser llenada por el Ingeniero)

        const firebaseConfig = {
  apiKey: "AIzaSyCkhGGnoJpAJSs3YC55EzHj2ETGSCvK63w",
  authDomain: "psiconet-360.firebaseapp.com",
  projectId: "psiconet-360",
  storageBucket: "psiconet-360.firebasestorage.app",
  messagingSenderId: "210998536370",
  appId: "1:210998536370:web:da23055d04f4491175c1ab"
};

        let db;
        let allSurveys = [];
        let isRealData = false; // Bandera para saber si son datos reales

        async function initAdmin() {
            try {
                console.log('üöÄ Iniciando carga del admin...');
                console.log('üìã Config Firebase:', firebaseConfig);
                
                if(firebaseConfig.apiKey === "TU_API_KEY") {
                    throw new Error("Configurar Firebase - API Key no seteada");
                }
                console.log('‚úÖ Config validada');
                
                const app = initializeApp(firebaseConfig);
                console.log('‚úÖ App inicializada:', app.name);
                
                db = getFirestore(app);
                console.log('‚úÖ Firestore inicializado:', firebaseConfig.projectId);
                console.log('üì° db object:', typeof db);

                try {
                  console.log('üìä Suscribiendo a colecci√≥n "encuestas_estudiantes" con onSnapshot...');
                  const colRef = collection(db, "encuestas_estudiantes");

                  // Listener en tiempo real
                  const unsubscribe = onSnapshot(colRef, (querySnapshot) => {
                      console.log('üì° Evento onSnapshot recibido. Documentos:', querySnapshot.size);
                      allSurveys = [];
                      querySnapshot.forEach((doc) => {
                          const data = doc.data();
                          console.log('üìÑ Documento:', doc.id, data);
                          allSurveys.push({ id: doc.id, ...data });
                      });

                      console.log('üìä Total de encuestas cargadas (onSnapshot):', allSurveys.length);
                      if (allSurveys.length > 0) {
                          isRealData = true;
                          showStatusMessage(`‚úÖ Mostrando ${allSurveys.length} encuesta(s) en tiempo real desde Firestore`, 'success');
                      } else {
                          isRealData = false;
                          showStatusMessage('‚è≥ Base de datos vac√≠a. Completa una encuesta en index.html para ver los datos aqu√≠.', 'info');
                      }
                      updateUI();
                  }, (err) => {
                      console.error('‚ùå onSnapshot error:', err?.code, err?.message || err);
                      let errorMsg = 'Error al conectar a Firestore. Ning√∫n dato disponible.';
                      if (err?.code === 'permission-denied') errorMsg = 'üîí Permiso denegado. Revisa las reglas de Firestore.';
                      showStatusMessage(errorMsg, 'error');
                      isRealData = false;
                      updateUI();
                  });

                  window._adminUnsubscribe = unsubscribe;
                  console.log('‚úÖ Listener de Firestore activo y escuchando cambios...');
                } catch (e) {
                  console.error('‚ùå Error CR√çTICO al conectar a Firestore:');
                  console.error('   C√≥digo:', e.code);
                  console.error('   Mensaje:', e.message);
                  console.error('   Detalles completos:', e);
                  
                  let errorMsg = 'Error fatal al inicializar Firestore. Ning√∫n dato disponible.';
                  isRealData = false;
                  updateUI();
                  showStatusMessage(errorMsg, 'error');
                }
            } catch (e) {
                console.error("‚ùå Error al inicializar Firebase:", e);
                isRealData = false;
                // NO cargar datos fake
                updateUI();
                showStatusMessage('Error: Firebase no configurado. Ning√∫n dato disponible.', 'error');
            }
        }

        function showStatusMessage(msg, type = 'info') {
            const msgDiv = document.getElementById('connection-status');
            if (msgDiv) {
                let bgClass = 'bg-blue-50 border border-blue-200 text-blue-800';
                if (type === 'success') bgClass = 'bg-green-50 border border-green-200 text-green-800';
                else if (type === 'warning') bgClass = 'bg-yellow-50 border border-yellow-200 text-yellow-800';
                else if (type === 'error') bgClass = 'bg-red-50 border border-red-200 text-red-800';
                
                msgDiv.innerHTML = `<div class="${bgClass} px-4 py-3 rounded text-sm font-medium">${msg}</div>`;
            }
        }

        function loadDummyData() {
            // Datos simulados completos
            allSurveys = [
                { 
                    id: "1", 
                    personal: { nombre: "Sof√≠a Mart√≠nez (Al D√≠a)", registro: "220001", semestre: "10mo Semestre", avance: "Voy al d√≠a", carga: "5", trabaja: "No" }, 
                    malla: [
                        // Simulaci√≥n de malla COMPLETA APROBADA (Representativa de alguien que termin√≥ todo)
                        // Semestre 1
                        {id: "sem-0-0", nombre: "Filosof√≠a", estado: "aprobado"}, {id: "sem-0-1", nombre: "Estad√≠stica I", estado: "aprobado"}, {id: "sem-0-2", nombre: "Sociolog√≠a I", estado: "aprobado"}, {id: "sem-0-3", nombre: "Antropolog√≠a Cultural", estado: "aprobado"}, {id: "sem-0-4", nombre: "Psicolog√≠a I", estado: "aprobado"}, {id: "sem-0-5", nombre: "Biopsicolog√≠a", estado: "aprobado"}, {id: "sem-0-6", nombre: "Estrategias de Aprendizaje", estado: "aprobado"},
                        // Semestre 2
                        {id: "sem-1-0", nombre: "Epistemolog√≠a", estado: "aprobado"}, {id: "sem-1-1", nombre: "Estad√≠stica II", estado: "aprobado"}, {id: "sem-1-2", nombre: "Sociolog√≠a II", estado: "aprobado"}, {id: "sem-1-3", nombre: "Antropolog√≠a Cultural Boliviana", estado: "aprobado"}, {id: "sem-1-4", nombre: "Psicolog√≠a II", estado: "aprobado"}, {id: "sem-1-5", nombre: "Psicofisiolog√≠a", estado: "aprobado"},
                        // Semestre 3
                        {id: "sem-2-0", nombre: "Investigaci√≥n I", estado: "aprobado"}, {id: "sem-2-1", nombre: "Psicolog√≠a Social", estado: "aprobado"}, {id: "sem-2-2", nombre: "Psicolog√≠a Etnoecol√≥gica", estado: "aprobado"}, {id: "sem-2-3", nombre: "Desarrollo Humano I", estado: "aprobado"}, {id: "sem-2-4", nombre: "Teor√≠as y Sistemas I", estado: "aprobado"}, {id: "sem-2-5", nombre: "Neuropsicolog√≠a I", estado: "aprobado"}, {id: "sem-2-6", nombre: "Aprendizaje", estado: "aprobado"},
                        // Semestre 4
                        {id: "sem-3-0", nombre: "Investigaci√≥n II", estado: "aprobado"}, {id: "sem-3-1", nombre: "Psicolog√≠a Grupal y Organizacional", estado: "aprobado"}, {id: "sem-3-2", nombre: "Desarrollo Humano II", estado: "aprobado"}, {id: "sem-3-3", nombre: "Teor√≠as y Sistemas II", estado: "aprobado"}, {id: "sem-3-4", nombre: "Neuropsicolog√≠a II", estado: "aprobado"}, {id: "sem-3-5", nombre: "Etolog√≠a", estado: "aprobado"},
                        // Semestre 5
                        {id: "sem-4-0", nombre: "Investigaci√≥n III", estado: "aprobado"}, {id: "sem-4-1", nombre: "Comportamiento y Sociedad", estado: "aprobado"}, {id: "sem-4-2", nombre: "Psicolog√≠a de la Personalidad I", estado: "aprobado"}, {id: "sem-4-3", nombre: "Evaluaci√≥n Psicol√≥gica I", estado: "aprobado"}, {id: "sem-4-4", nombre: "Psicopatolog√≠a I", estado: "aprobado"}, {id: "sem-4-5", nombre: "Psicolog√≠a Cognitiva I", estado: "aprobado"},
                        // Semestre 6
                        {id: "sem-5-0", nombre: "Investigaci√≥n IV", estado: "aprobado"}, {id: "sem-5-1", nombre: "Diagn√≥stico de Necesidades", estado: "aprobado"}, {id: "sem-5-2", nombre: "Psicolog√≠a de la Personalidad II", estado: "aprobado"}, {id: "sem-5-3", nombre: "Evaluaci√≥n Psicol√≥gica II", estado: "aprobado"}, {id: "sem-5-4", nombre: "Psicopatolog√≠a II", estado: "aprobado"}, {id: "sem-5-5", nombre: "Psicoan√°lisis", estado: "aprobado"}, {id: "sem-5-6", nombre: "Psicolog√≠a Cognitiva II", estado: "aprobado"},
                        // Semestre 7
                        {id: "sem-6-0", nombre: "Investigaci√≥n V", estado: "aprobado"}, {id: "sem-6-1", nombre: "Proyectos I", estado: "aprobado"}, {id: "sem-6-2", nombre: "Tec. de Int. Socio - Organizacional I", estado: "aprobado"}, {id: "sem-6-3", nombre: "T√©cnicas Proyectivas", estado: "aprobado"}, {id: "sem-6-4", nombre: "Tec. de Int. Cl√≠nica I", estado: "aprobado"}, {id: "sem-6-5", nombre: "Tec. de Int. Educativa I", estado: "aprobado"},
                        // Semestre 8
                        {id: "sem-7-0", nombre: "Investigaci√≥n VI", estado: "aprobado"}, {id: "sem-7-1", nombre: "Proyectos II", estado: "aprobado"}, {id: "sem-7-2", nombre: "Tec. de Int. Socio - Organizacional II", estado: "aprobado"}, {id: "sem-7-3", nombre: "Psicodiagn√≥stico", estado: "aprobado"}, {id: "sem-7-4", nombre: "Tec. de Int. Cl√≠nica II", estado: "aprobado"}, {id: "sem-7-5", nombre: "Tec. de Int. Educativa II", estado: "aprobado"},
                        // Semestre 9
                        {id: "sem-8-0", nombre: "√âtica Profesional I", estado: "aprobado"},
                        {id: "mod9-humanista-0", nombre: "Abordaje Cl√≠nico I", estado: "aprobado"}, {id: "mod9-humanista-1", nombre: "Abordaje Educativo I", estado: "aprobado"}, {id: "mod9-humanista-2", nombre: "Abordaje Socio Org I", estado: "aprobado"},
                        // Semestre 10
                        {id: "sem-9-0", nombre: "√âtica Profesional II", estado: "aprobado"},
                        {id: "mod10-humanista-0", nombre: "Abordaje Cl√≠nico II", estado: "aprobado"}, {id: "mod10-humanista-1", nombre: "Abordaje Educativo II", estado: "aprobado"}, {id: "mod10-humanista-2", nombre: "Abordaje Socio Org II", estado: "aprobado"},
                        // Electivas y Talleres
                        {id: "elec-0", nombre: "Electiva I", estado: "aprobado"}, {id: "elec-1", nombre: "Electiva II", estado: "aprobado"}, {id: "elec-2", nombre: "Electiva III", estado: "aprobado"}, {id: "elec-3", nombre: "Electiva IV", estado: "aprobado"},
                        {id: "taller-0", nombre: "Taller I", estado: "aprobado"}, {id: "taller-1", nombre: "Taller II", estado: "aprobado"}, {id: "taller-2", nombre: "Taller III", estado: "aprobado"}, {id: "taller-3", nombre: "Taller IV", estado: "aprobado"}
                    ], 
                    seccion2_cierre: { q10: "No" },
                    seccion3: { q11: "Motivado", q12: "Claridad" },
                    seccion4: { prioridad: "Ninguna (Voy bien)" },
                    seccion5: { propuesta: "Mantener el ritmo actual." }
                },
                { 
                    id: "2", 
                    personal: { nombre: "Carlos M√©ndez", registro: "220002", semestre: "5to Semestre", avance: "Atraso moderado", carga: "3", trabaja: "S√≠" }, 
                    malla: [
                        {id: "sem-0-0", nombre: "Filosof√≠a", estado: "aprobado"}, {id: "sem-1-0", nombre: "Neuroanatom√≠a", estado: "aprobado"},
                        {id: "sem-2-1", nombre: "Psicolog√≠a Social", estado: "pendiente"}
                    ], 
                    seccion2_cierre: { q10: "Si" },
                    seccion3: { q11: "Preocupado", q12: "Organizacion" },
                    seccion4: { prioridad: "Tutor√≠as acad√©micas personalizadas" },
                    seccion5: { propuesta: "No cerrar grupos con pocos alumnos." }
                },
                { 
                    id: "3", 
                    personal: { nombre: "Lucia Fernandez", registro: "221003", semestre: "3er Semestre", avance: "Voy al d√≠a", carga: "6", trabaja: "No" }, 
                    malla: [
                        {id: "sem-0-0", nombre: "Filosof√≠a", estado: "aprobado"}, {id: "sem-0-1", nombre: "Estad√≠stica I", estado: "aprobado"},
                        {id: "sem-1-0", nombre: "Epistemolog√≠a", estado: "aprobado"}
                    ], 
                    seccion2_cierre: { q10: "No se" },
                    seccion3: { q11: "Confundido", q12: "Ninguna" },
                    seccion4: { prioridad: "Semestres de igualaci√≥n" },
                    seccion5: { propuesta: "Explicar mejor los cambios." }
                },
                { 
                    id: "4", 
                    personal: { nombre: "Pedro Almodovar", registro: "218004", semestre: "9no Semestre", avance: "Atraso significativo", carga: "4", trabaja: "S√≠" }, 
                    malla: [
                        {id: "sem-8-0", nombre: "√âtica Profesional I", estado: "reprobado"}
                    ], 
                    seccion2_cierre: { q10: "Depende", explicacion: "Si me convalidan todo." },
                    seccion3: { q11: "Cauteloso", q12: "Claridad" },
                    seccion4: { prioridad: "Adaptaci√≥n flexible de prerrequisitos" },
                    seccion5: { propuesta: "Convalidaci√≥n autom√°tica." }
                }
            ];
        }

        window.initAdmin = initAdmin;

        function updateUI() {
            renderDashboard();
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('students-table-body');
            tbody.innerHTML = '';
            
            if (allSurveys.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-500">No hay encuestas registradas a√∫n.</td></tr>';
                return;
            }

            allSurveys.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 border-b border-slate-100 cursor-pointer transition-colors group";
                tr.onclick = () => openStudentDetail(s);
                
                const aprobadas = s.malla ? s.malla.filter(m => m.estado === 'aprobado').length : 0;
                const sentimiento = s.seccion3?.q11 || 'Sin respuesta';
                
                // Badge de estado
                let estadoBadge = `<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold">Sin datos</span>`;
                
                if(s.personal?.avance?.includes('d√≠a')) {
                    estadoBadge = `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">Al d√≠a</span>`;
                } else if(s.personal?.avance?.includes('atrasado') || s.personal?.avance?.includes('moderado') || s.personal?.avance?.includes('significativo')) {
                    estadoBadge = `<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold">Atrasado</span>`;
                }
                
                // Badge de sentimiento
                let sentimentBadge = 'bg-slate-100 text-slate-600';
                if (sentimiento === 'Motivado') sentimentBadge = 'bg-green-100 text-green-700';
                else if (sentimiento === 'Preocupado') sentimentBadge = 'bg-red-100 text-red-700';
                else if (sentimiento === 'Cauteloso') sentimentBadge = 'bg-blue-100 text-blue-700';
                else if (sentimiento === 'Confundido') sentimentBadge = 'bg-orange-100 text-orange-700';

                tr.innerHTML = `
                    <td class="p-4">
                        <div class="font-bold text-slate-800">${s.personal?.nombre || 'An√≥nimo'}</div>
                        <div class="text-xs text-slate-500 md:hidden">${s.personal?.registro || '-'}</div>
                    </td>
                    <td class="p-4 text-slate-600 hidden md:table-cell">${s.personal?.registro || '-'}</td>
                    <td class="p-4 text-slate-600 font-medium">${s.personal?.semestre || '-'}</td>
                    <td class="p-4">${estadoBadge}</td>
                    <td class="p-4 hidden lg:table-cell">
                        <span class="px-2 py-1 rounded text-xs font-medium ${sentimentBadge}">${sentimiento}</span>
                    </td>
                    <td class="p-4 text-slate-600 text-sm">${aprobadas} mat.</td>
                    <td class="p-4 text-right text-slate-300 group-hover:text-blue-600 transition-colors">
                        <i class="fas fa-eye"></i>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('total-count').innerText = allSurveys.length;
        }

        function renderDashboard() {
            // Gr√°fico 1: AVANCE
            const avanceCounts = {};
            allSurveys.forEach(s => {
                const val = s.personal?.avance || "Sin datos";
                avanceCounts[val] = (avanceCounts[val] || 0) + 1;
            });

            if (window.chartAvance) window.chartAvance.destroy();
            const ctxAvance = document.getElementById('chart-avance');
            if (ctxAvance) {
                window.chartAvance = new Chart(ctxAvance, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(avanceCounts).length > 0 ? Object.keys(avanceCounts) : ['Sin datos'],
                        datasets: [{
                            data: Object.values(avanceCounts).length > 0 ? Object.values(avanceCounts) : [1],
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#64748b'],
                            borderWidth: 1
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { 
                                position: 'bottom', 
                                labels: { 
                                    boxWidth: 10, 
                                    font: { size: 10 },
                                    padding: 10
                                } 
                            },
                            tooltip: { enabled: true }
                        }
                    }
                });
            }

            // Gr√°fico 2: SENTIMIENTO
            const sentimentCounts = {};
            allSurveys.forEach(s => {
                let val = s.seccion3?.q11 || "Sin respuesta";
                sentimentCounts[val] = (sentimentCounts[val] || 0) + 1;
            });

            if (window.chartSentiment) window.chartSentiment.destroy();
            const ctxSentiment = document.getElementById('chart-sentiment');
            if (ctxSentiment) {
                window.chartSentiment = new Chart(ctxSentiment, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(sentimentCounts).length > 0 ? Object.keys(sentimentCounts) : ['Sin datos'],
                        datasets: [{
                            label: 'Estudiantes',
                            data: Object.values(sentimentCounts).length > 0 ? Object.values(sentimentCounts) : [0],
                            backgroundColor: '#1e3a8a',
                            borderRadius: 4,
                            borderSkipped: false
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        indexAxis: 'x',
                        plugins: { 
                            legend: { display: false },
                            tooltip: { enabled: true }
                        },
                        scales: { 
                            y: { 
                                beginAtZero: true, 
                                ticks: { stepSize: 1 },
                                max: Math.max(...Object.values(sentimentCounts), 1) + 1
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico 3: PRIORIDAD
            const priorityCounts = {};
            allSurveys.forEach(s => {
                let val = s.seccion4?.prioridad || "Sin respuesta";
                if(val.length > 20) val = val.substring(0, 20) + "...";
                priorityCounts[val] = (priorityCounts[val] || 0) + 1;
            });

            if (window.chartPriority) window.chartPriority.destroy();
            const ctxPriority = document.getElementById('chart-priority');
            if (ctxPriority) {
                window.chartPriority = new Chart(ctxPriority, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(priorityCounts).length > 0 ? Object.keys(priorityCounts) : ['Sin datos'],
                        datasets: [{
                            label: 'Votos',
                            data: Object.values(priorityCounts).length > 0 ? Object.values(priorityCounts) : [0],
                            backgroundColor: '#8b5cf6',
                            borderRadius: 4,
                            borderSkipped: false
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { 
                            legend: { display: false },
                            tooltip: { enabled: true }
                        },
                        scales: { 
                            x: { 
                                beginAtZero: true, 
                                ticks: { stepSize: 1 },
                                max: Math.max(...Object.values(priorityCounts), 1) + 1
                            }
                        }
                    }
                });
            }
        }

        window.openStudentDetail = (student) => {
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('modal-content-body');
            
            // Funci√≥n auxiliar para mostrar listas
            const listToString = (arr) => {
                if (!arr) return '-';
                if (Array.isArray(arr)) return arr.join(', ') || '-';
                return String(arr);
            };
            
            let html = `
                <!-- DATOS PERSONALES -->
                <div class="bg-blue-50 p-4 rounded-lg mb-6 border border-blue-100 shadow-sm">
                    <h4 class="text-blue-900 font-bold mb-3 border-b border-blue-200 pb-1 flex items-center gap-2"><i class="fas fa-id-card"></i> Secci√≥n 1: Datos Personales</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-y-2 gap-x-4 text-sm">
                        <p><span class="text-slate-500 font-semibold">Nombre:</span> ${student.personal?.nombre || '-'}</p>
                        <p><span class="text-slate-500 font-semibold">Registro:</span> ${student.personal?.registro || '-'}</p>
                        <p><span class="text-slate-500 font-semibold">Celular:</span> ${student.personal?.celular || '-'}</p>
                        <p><span class="text-slate-500 font-semibold">Correo:</span> ${student.personal?.correo || '-'}</p>
                        <p><span class="text-slate-500 font-semibold">Semestre:</span> ${student.personal?.semestre || '-'}</p>
                        <p><span class="text-slate-500 font-semibold">Carga Acad√©mica:</span> ${student.personal?.carga_academica || '-'} materias</p>
                        <p><span class="text-slate-500 font-semibold">Trabaja:</span> ${student.personal?.trabaja || '-'}</p>
                        <p><span class="text-slate-500 font-semibold">Avance Reportado:</span> <span class="text-blue-700 font-bold">${student.personal?.avance || '-'}</span></p>
                    </div>
                </div>

                <!-- MALLA CURRICULAR -->
                <div class="mb-6">
                    <h4 class="text-slate-800 font-bold mb-3 border-b pb-1 flex items-center gap-2"><i class="fas fa-th"></i> Secci√≥n 2: Malla Curricular Reportada</h4>
                    <div class="bg-slate-100 p-4 rounded-xl border border-slate-200 overflow-x-auto">
                        ${renderFullMalla(student.malla)}
                    </div>
                    <div class="mt-3 text-sm bg-white border border-slate-200 p-4 rounded shadow-sm">
                        <p class="mb-2"><span class="text-slate-700 font-bold">P10. ¬øEstas materias afectan tu avance?</span></p>
                        <p class="text-blue-900 font-medium text-lg">${student.seccion2_cierre?.q10 || '-'}</p>
                        ${student.seccion2_cierre?.explicacion ? `<p class="text-slate-600 mt-2 italic pl-3 border-l-4 border-blue-300 bg-blue-50 py-2">"${student.seccion2_cierre.explicacion}"</p>` : ''}
                    </div>
                </div>

                <!-- SECCI√ìN 3: EXPECTATIVAS -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white border border-slate-200 p-4 rounded-lg shadow-sm">
                        <h5 class="text-slate-800 font-bold mb-2 text-sm border-b pb-2"><i class="fas fa-heart mr-1"></i>P11. Sentimiento frente al nuevo curr√≠culo</h5>
                        <p class="text-slate-700 font-medium">${student.seccion3?.q11 || '-'}</p>
                    </div>
                    <div class="bg-white border border-slate-200 p-4 rounded-lg shadow-sm">
                        <h5 class="text-slate-800 font-bold mb-2 text-sm border-b pb-2"><i class="fas fa-lightbulb mr-1"></i>P12. Qu√© aportar√° el nuevo curr√≠culo</h5>
                        <p class="text-slate-700 font-medium">${student.seccion3?.q12 || '-'}</p>
                        ${student.seccion3?.q12_otra ? `<p class="text-slate-600 mt-2 italic text-xs border-t pt-2">(Otra opini√≥n: "${student.seccion3.q12_otra}")</p>` : ''}
                    </div>
                </div>

                <!-- SECCI√ìN 4: MEDIDAS -->
                <div class="bg-white border border-slate-200 p-4 rounded-lg shadow-sm mb-6">
                    <h5 class="text-slate-800 font-bold mb-3 border-b pb-2"><i class="fas fa-tasks mr-1"></i>P13. Medidas √∫tiles para tu avance (Selecci√≥n m√∫ltiple)</h5>
                    <p class="text-slate-700 text-sm mb-2">${listToString(student.seccion4?.q13) || '-'}</p>
                    ${student.seccion4?.q13_otros ? `<p class="text-slate-600 text-xs italic border-l-4 border-orange-300 pl-3 bg-orange-50 py-2">(Otros: "${student.seccion4.q13_otros}")</p>` : ''}
                </div>

                <div class="bg-white border border-slate-200 p-4 rounded-lg shadow-sm mb-6">
                    <h5 class="text-slate-800 font-bold mb-2 border-b pb-2"><i class="fas fa-star mr-1"></i>P14. Prioridad absoluta (Una sola opci√≥n)</h5>
                    <p class="text-slate-700 font-medium">${student.seccion4?.prioridad || '-'}</p>
                </div>

                <!-- SECCI√ìN 5: COMENTARIOS FINALES -->
                <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                    <h5 class="text-yellow-900 font-bold mb-2"><i class="fas fa-comment-dots mr-1"></i>Secci√≥n 5: Propuesta para mejorar la transici√≥n</h5>
                    <p class="text-slate-700 italic text-sm leading-relaxed">"${student.seccion5?.propuesta || 'Sin comentarios.'}"</p>
                </div>
            `;

            content.innerHTML = html;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        // Funci√≥n mejorada para reconstruir visualmente la malla
        function renderFullMalla(mallaData) {
            if (!mallaData || mallaData.length === 0) return '<p class="text-center text-slate-400 italic py-4">No se registraron materias.</p>';
            
            // 1. Organizar materias por semestre (columna)
            const columns = {};
            // Inicializar al menos 10 columnas
            for(let i=0; i<10; i++) columns[i] = [];
            
            mallaData.forEach(m => {
                // Parsear ID (ej: "sem-0-1" -> col 0, row 1)
                if (m.id && m.id.startsWith("sem-")) {
                    const parts = m.id.split('-');
                    const colIndex = parseInt(parts[1]);
                    // Guardamos la materia en su columna correspondiente
                    if (columns[colIndex]) {
                        columns[colIndex].push(m);
                    }
                } else if (m.id && (m.id.startsWith("elec-") || m.id.startsWith("taller-"))) {
                    // Electivas y Talleres van aparte o al final (podr√≠amos ponerlos en una col extra 11)
                    if(!columns[10]) columns[10] = [];
                    columns[10].push(m);
                } else if (m.id && m.id.startsWith("mod")) {
                    // Modalidades (9no y 10mo semestre din√°micos)
                    // Las IDs son mod9-... o mod10-...
                    if (m.id.startsWith("mod9-")) {
                        if (!columns[8]) columns[8] = [];
                        columns[8].push(m);
                    } else if (m.id.startsWith("mod10-")) {
                        if (!columns[9]) columns[9] = [];
                        columns[9].push(m);
                    }
                }
            });

            // 2. Construir HTML
            let html = '<div class="flex gap-2 overflow-x-auto pb-2" style="min-width: max-content;">';
            
            // Recorrer columnas ordenadas
            for (let i = 0; i <= 10; i++) {
                if (!columns[i] || columns[i].length === 0) continue; // Saltar columnas vac√≠as si se prefiere
                
                let semTitle = (i < 10) ? `${i+1}¬∫ Sem` : "Elect/Tall";
                
                html += `<div class="flex flex-col gap-2 w-28 shrink-0">
                            <div class="text-center text-[10px] font-bold text-slate-400 uppercase border-b border-slate-300 pb-1 mb-1">${semTitle}</div>`;
                
                columns[i].forEach(m => {
                    let bgClass = "bg-white border-slate-200 text-slate-400";
                    let icon = "";
                    
                    if (m.estado === 'aprobado') { 
                        bgClass = "bg-green-100 border-green-300 text-green-900 font-bold"; 
                        icon = '<i class="fas fa-check text-[10px] opacity-60"></i>';
                    } else if (m.estado === 'reprobado') { 
                        bgClass = "bg-red-100 border-red-300 text-red-900"; 
                        icon = '<i class="fas fa-times text-[10px] opacity-60"></i>';
                    } else if (m.estado === 'levantamiento') { 
                        bgClass = "bg-blue-100 border-blue-300 text-blue-900"; 
                        icon = '<i class="fas fa-arrow-up text-[10px] opacity-60"></i>';
                    }

                    html += `<div class="p-2 rounded border text-[10px] flex items-center justify-center text-center h-14 relative leading-tight ${bgClass}" title="${m.nombre}">
                                ${m.nombre}
                                <div class="absolute top-0.5 right-1">${icon}</div>
                             </div>`;
                });
                
                html += `</div>`;
            }
            
            html += '</div>';
            return html;
        }

        window.closeModal = () => {
            const modal = document.getElementById('detail-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        document.getElementById('detail-modal')?.addEventListener('click', (e) => {
            if (e.target === document.getElementById('detail-modal')) window.closeModal();
        });

        initAdmin();
    </script>
    </head>
    <body
        class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex flex-col font-sans">

        <!-- Header Admin -->
        <header
            class="bg-blue-900 text-white p-4 shadow-md flex justify-between items-center z-10 shrink-0">
            <div class="flex items-center gap-3">
                <div
                    class="bg-white p-1 rounded h-10 w-10 flex items-center justify-center text-blue-900 shadow">
                    <i class="fas fa-university text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold leading-tight">Panel de
                        Administraci√≥n</h1>
                    <p class="text-blue-200 text-xs">Resultados en Tiempo
                        Real</p>
                </div>
            </div>
            <div
                class="bg-blue-800 px-4 py-2 rounded-lg text-sm shadow-inner border border-blue-700">
                Total: <span id="total-count"
                    class="font-bold text-white text-lg ml-1">0</span>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">

            <!-- Sidebar (Estad√≠sticas) -->
            <aside
                class="w-80 bg-white border-r border-slate-200 p-6 hidden lg:block overflow-y-auto shadow-sm z-0 scrollbar-thin">
                <h3
                    class="font-bold text-slate-400 text-xs uppercase tracking-wider mb-6 pb-2 border-b border-slate-100">Resumen
                    Estad√≠stico</h3>

                <div class="space-y-8">
                    <!-- Gr√°fico 1 -->
                    <div>
                        <h4
                            class="text-xs font-bold text-slate-700 mb-2 text-center uppercase">Estado
                            de Avance (P9)</h4>
                        <div class="h-40 relative">
                            <canvas id="chart-avance"></canvas>
                        </div>
                    </div>

                    <!-- Gr√°fico 2 -->
                    <div>
                        <h4
                            class="text-xs font-bold text-slate-700 mb-2 text-center uppercase">Sentimiento
                            (P11)</h4>
                        <div class="h-40 relative">
                            <canvas id="chart-sentiment"></canvas>
                        </div>
                    </div>

                    <!-- Gr√°fico 3 -->
                    <div>
                        <h4
                            class="text-xs font-bold text-slate-700 mb-2 text-center uppercase">Prioridad
                            (P14)</h4>
                        <div class="h-48 relative">
                            <canvas id="chart-priority"></canvas>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content (Lista de Estudiantes) -->
            <main
                class="flex-1 overflow-hidden flex flex-col bg-slate-50 relative">
                <!-- Barra superior -->
                <div
                    class="p-4 border-b border-slate-200 bg-white flex justify-between items-center shrink-0 shadow-sm">
                    <h2
                        class="font-bold text-slate-700 flex items-center gap-2"><i
                            class="fas fa-users text-blue-900"></i> Lista de
                        Encuestas</h2>
                    <button onclick="initAdmin()"
                        class="text-blue-600 hover:text-blue-800 text-sm flex items-center gap-1 transition-colors px-3 py-1 rounded hover:bg-blue-50">
                        <i class="fas fa-sync-alt"></i> Actualizar Datos
                    </button>
                </div>

                <!-- Estado de Conexi√≥n -->
                <div id="connection-status" class="px-6 pt-4 shrink-0">
                </div>

                <!-- Tabla -->
                <div class="flex-1 overflow-auto p-4 md:p-6">
                    <div
                        class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left border-collapse">
                            <thead
                                class="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500 font-semibold tracking-wider sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="p-4">Estudiante</th>
                                    <th
                                        class="p-4 hidden md:table-cell">Registro</th>
                                    <th class="p-4">Semestre</th>
                                    <th
                                        class="p-4 hidden lg:table-cell">Estado</th>
                                    <th class="p-4 hidden lg:table-cell">Sentimiento</th>
                                    <th class="p-4">Materias</th>
                                    <th class="p-4 text-right">Ver</th>
                                </tr>
                            </thead>
                            <tbody id="students-table-body"
                                class="text-sm divide-y divide-slate-100 bg-white">
                                <tr>
                                    <td colspan="6" class="p-8 text-center">
                                        <i
                                            class="fas fa-spinner fa-spin text-blue-900 text-2xl"></i>
                                        <p
                                            class="text-slate-500 mt-2">Cargando...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <p
                        class="text-center text-xs text-slate-400 mt-4 mb-2">Mostrando
                        registros m√°s recientes primero.</p>
                </div>
            </main>
        </div>

        <!-- Modal Detalle -->
        <div id="detail-modal"
            class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm hidden z-50 items-center justify-center p-4 transition-opacity duration-300">
            <div
                class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform transition-all scale-100 border border-slate-200">
                <!-- Modal Header -->
                <div
                    class="p-4 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-xl sticky top-0 z-10 shadow-sm">
                    <h3
                        class="font-bold text-lg text-slate-800 flex items-center gap-2">
                        <span
                            class="bg-blue-100 text-blue-800 p-2 rounded-full h-8 w-8 flex items-center justify-center"><i
                                class="fas fa-user-graduate text-sm"></i></span>
                        Reporte Individual de Estudiante
                    </h3>
                    <button onclick="closeModal()"
                        class="text-slate-400 hover:text-red-500 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Modal Body -->
                <div id="modal-content-body"
                    class="p-6 overflow-y-auto bg-slate-50 custom-scrollbar">
                    <!-- Contenido inyectado por JS -->
                </div>

                <!-- Modal Footer -->
                <div
                    class="p-4 border-t border-slate-100 bg-white rounded-b-xl flex justify-end shrink-0">
                    <button onclick="closeModal()"
                        class="px-6 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium text-sm shadow-sm transition-all hover:shadow-md">
                        Cerrar Reporte
                    </button>
                </div>
            </div>
        </div>

    </body>
</html>