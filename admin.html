<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin - Encuesta Psicolog√≠a</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet">

        <!-- Firebase SDKs -->
        <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIGURACI√ìN
        const firebaseConfig = {
          apiKey: "AIzaSyCkhGGnoJpAJSs3YC55EzHj2ETGSCvK63w",
          authDomain: "psiconet-360.firebaseapp.com",
          projectId: "psiconet-360",
          storageBucket: "psiconet-360.firebasestorage.app",
          messagingSenderId: "210998536370",
          appId: "1:210998536370:web:da23055d04f4491175c1ab"
        };

        let db;
        let allSurveys = [];
        let isRealData = false;
        let surveyToDeleteId = null;

        // --- FUNCI√ìN DE B√öSQUEDA PROFUNDA (Deep Search) ---
        // Busca una propiedad en el documento sin importar d√≥nde est√© escondida
        function getField(doc, ...keys) {
            if (!doc) return undefined;
            const data = doc.data ? doc.data() : doc; 
            
            const isValid = (val) => val !== undefined && val !== null && val !== "";

            // 1. B√∫squeda Directa (Ra√≠z y Personal)
            for (const key of keys) {
                // Prioridad 1: Buscar en la ra√≠z del objeto
                if (isValid(data[key])) return data[key];
                
                // Prioridad 2: Buscar dentro de 'personal' (estructura antigua)
                if (data.personal && isValid(data.personal[key])) return data.personal[key];

                // Prioridad 3: Variaciones de May√∫sculas/Min√∫sculas
                if (typeof key === 'string') {
                    const lower = key.toLowerCase();
                    const upper = key.toUpperCase();
                    const cap = key.charAt(0).toUpperCase() + key.slice(1);

                    // Check Root
                    if (isValid(data[lower])) return data[lower];
                    if (isValid(data[upper])) return data[upper];
                    if (isValid(data[cap])) return data[cap];

                    // Check Personal
                    if (data.personal) {
                        if (isValid(data.personal[lower])) return data.personal[lower];
                        if (isValid(data.personal[upper])) return data.personal[upper];
                        if (isValid(data.personal[cap])) return data.personal[cap];
                    }
                }
            }
            // 2. B√∫squeda Profunda en sub-objetos (por si se guard√≥ en 'seccion1', etc.)
            for (const prop in data) {
                if (typeof data[prop] === 'object' && data[prop] !== null && !Array.isArray(data[prop]) && prop !== 'personal') {
                    for (const key of keys) {
                        if (isValid(data[prop][key])) return data[prop][key];
                        if (typeof key === 'string') {
                             if(isValid(data[prop][key.toLowerCase()])) return data[prop][key.toLowerCase()];
                        }
                    }
                }
            }
            return undefined;
        }

        // --- FORMATO DE LISTAS ---
        function formatListAsBadges(val) {
            if (!val) return '<span class="text-slate-400 italic text-xs">Sin datos</span>';
            // Normalizar a array
            let arr = Array.isArray(val) ? val : [String(val)];
            
            // Caso especial: String separado por comas
            if (arr.length === 1 && typeof arr[0] === 'string' && arr[0].includes(',')) {
                 arr = arr[0].split(',').map(s => s.trim());
            }

            if (arr.length === 0 || (arr.length === 1 && arr[0] === "")) return '<span class="text-slate-400 italic text-xs">Sin selecci√≥n</span>';

            return arr.map(item => 
                `<span class="inline-block bg-blue-100 text-blue-800 text-[11px] font-bold px-2 py-1 rounded-md border border-blue-200 mr-1 mb-1 shadow-sm whitespace-nowrap">${item}</span>`
            ).join('');
        }

        async function initAdmin() {
            try {
                console.log('üöÄ Iniciando carga del admin...');
                
                if(firebaseConfig.apiKey === "TU_API_KEY") {
                    throw new Error("Configurar Firebase - API Key no seteada");
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);

                try {
                  const colRef = collection(db, "encuestas_estudiantes");

                  // Listener en tiempo real
                  const unsubscribe = onSnapshot(colRef, (querySnapshot) => {
                      if (querySnapshot.size === 0) {
                          loadDummyData();
                          isRealData = false;
                          showStatusMessage('‚ÑπÔ∏è Modo Demo: Base de datos vac√≠a. Mostrando datos de ejemplo.', 'warning');
                      } else {
                          allSurveys = [];
                          querySnapshot.forEach((doc) => {
                              const data = doc.data();
                              allSurveys.push({ id: doc.id, ...data });
                          });
                          isRealData = true;
                          showStatusMessage(`‚úÖ Mostrando ${allSurveys.length} encuesta(s) en tiempo real desde Firestore`, 'success');
                      }
                      updateUI();
                  }, (err) => {
                      console.error('‚ùå onSnapshot error:', err);
                      loadDummyData();
                      isRealData = false;
                      showStatusMessage('Error de conexi√≥n. Mostrando Demo.', 'error');
                      updateUI();
                  });

                  window._adminUnsubscribe = unsubscribe;
                } catch (e) {
                  console.error('‚ùå Error CR√çTICO:', e);
                  loadDummyData();
                  isRealData = false;
                  updateUI();
                }
            } catch (e) {
                console.error("‚ùå Error init:", e);
                loadDummyData();
                isRealData = false;
                updateUI();
            }
        }

        function showStatusMessage(msg, type = 'info') {
            const msgDiv = document.getElementById('connection-status');
            if (msgDiv) {
                let bgClass = 'bg-blue-50 border border-blue-200 text-blue-800';
                if (type === 'success') bgClass = 'bg-green-50 border border-green-200 text-green-800';
                else if (type === 'warning') bgClass = 'bg-yellow-50 border border-yellow-200 text-yellow-800';
                else if (type === 'error') bgClass = 'bg-red-50 border border-red-200 text-red-800';
                
                msgDiv.innerHTML = `<div class="${bgClass} px-4 py-3 rounded text-sm font-medium flex items-center gap-2"><i class="fas fa-info-circle"></i> ${msg}</div>`;
            }
        }

        function loadDummyData() {
            // Datos simulados (Demo)
            allSurveys = [
                { 
                    id: "demo-1", 
                    personal: { 
                        nombre: "Sof√≠a Mart√≠nez", registro: "220001", CI: "1234567 SC", celular: "70012345", correo: "sofia@mail.com", 
                        semestre: ["10mo Semestre"], 
                        carga_academica: "5", trabaja: "No", horas_estudio: "4", avance: "Voy al d√≠a" 
                    }, 
                    malla: [{id: "sem-0-0", nombre: "Filosof√≠a", estado: "aprobado"}, {id: "sem-9-0", nombre: "√âtica Profesional II", estado: "aprobado"}], 
                    seccion2_cierre: { q10: "No" }, 
                    seccion3: { q11: "Motivado", q12: "Claridad" }, 
                    seccion4: { prioridad: "Ninguna (Voy bien)", q13: ["Ninguna"] }, 
                    seccion5: { propuesta: "Mantener el ritmo actual." }
                },
                { 
                    id: "demo-3", 
                    personal: { 
                        nombre: "Lucia Fernandez (Multi-Semestre)", registro: "221003", CI: "4567890 CB", celular: "77788899", correo: "lucia@mail.com", 
                        semestre: ["1er Semestre", "2do Semestre", "3er Semestre"], 
                        carga_academica: "6", trabaja: "No", horas_estudio: "6", avance: "Voy al d√≠a" 
                    }, 
                    malla: [], 
                    seccion2_cierre: { q10: "No se" },
                    seccion3: { q11: "Confundido", q12: "Ninguna" },
                    seccion4: { prioridad: "Semestres de igualaci√≥n", q13: ["Semestres de igualaci√≥n"] },
                    seccion5: { propuesta: "Explicar mejor los cambios." }
                }
            ];
        }

        window.initAdmin = initAdmin;
        window.getField = getField;

        // L√≥gica de Pesta√±as
        window.switchTab = (tabName) => {
            const listBtn = document.getElementById('tab-btn-list');
            const statsBtn = document.getElementById('tab-btn-stats');
            const listView = document.getElementById('view-list');
            const statsView = document.getElementById('view-stats');

            if(tabName === 'list') {
                listBtn.classList.add('border-blue-900', 'text-blue-900');
                listBtn.classList.remove('border-transparent', 'text-slate-500');
                statsBtn.classList.remove('border-blue-900', 'text-blue-900');
                statsBtn.classList.add('border-transparent', 'text-slate-500');
                listView.classList.remove('hidden');
                statsView.classList.add('hidden');
            } else {
                statsBtn.classList.add('border-blue-900', 'text-blue-900');
                statsBtn.classList.remove('border-transparent', 'text-slate-500');
                listBtn.classList.remove('border-blue-900', 'text-blue-900');
                listBtn.classList.add('border-transparent', 'text-slate-500');
                statsView.classList.remove('hidden');
                listView.classList.add('hidden');
                setTimeout(renderDashboard, 100);
            }
        };

        // L√≥gica de Eliminaci√≥n
        window.confirmDelete = (id) => {
            surveyToDeleteId = id;
            const modal = document.getElementById('delete-confirm-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.closeDeleteModal = () => {
            surveyToDeleteId = null;
            const modal = document.getElementById('delete-confirm-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        window.executeDelete = async () => {
            if (!surveyToDeleteId) return;
            if (!isRealData) {
                showStatusMessage('‚ö†Ô∏è Modo Demo: No se pueden eliminar los datos de ejemplo.', 'warning');
                window.closeDeleteModal();
                return;
            }
            const btn = document.getElementById('btn-confirm-delete');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Borrando...';
            btn.disabled = true;
            try {
                await deleteDoc(doc(db, "encuestas_estudiantes", surveyToDeleteId));
                showStatusMessage('‚úÖ Encuesta eliminada correctamente.', 'success');
            } catch (error) {
                console.error("Error al eliminar:", error);
                showStatusMessage('‚ùå Error al eliminar: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                window.closeDeleteModal();
            }
        };

        function updateUI() {
            renderDashboard();
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('students-table-body');
            tbody.innerHTML = '';
            
            if (allSurveys.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-slate-500">No hay encuestas registradas a√∫n.</td></tr>';
                return;
            }

            allSurveys.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 border-b border-slate-100 cursor-pointer transition-colors group";
                tr.onclick = () => openStudentDetail(s);
                
                const aprobadas = s.malla ? s.malla.filter(m => m.estado === 'aprobado').length : 0;
                
                const avanceVal = getField(s, 'avance', 'Avance'); 
                const sentimiento = getField(s, 'q11') || 'Sin respuesta';
                
                let estadoBadge = `<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold">Sin datos</span>`;
                
                if (avanceVal && typeof avanceVal === 'string') {
                    if(avanceVal.includes('d√≠a')) {
                        estadoBadge = `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">Al d√≠a</span>`;
                    } else if(avanceVal.includes('atrasado') || avanceVal.includes('moderado') || avanceVal.includes('significativo')) {
                        estadoBadge = `<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold">Atrasado</span>`;
                    }
                }
                
                let sentimentBadge = 'bg-slate-100 text-slate-600';
                if (sentimiento === 'Motivado') sentimentBadge = 'bg-green-100 text-green-700';
                else if (sentimiento === 'Preocupado') sentimentBadge = 'bg-red-100 text-red-700';
                else if (sentimiento === 'Cauteloso') sentimentBadge = 'bg-blue-100 text-blue-700';
                else if (sentimiento === 'Confundido') sentimentBadge = 'bg-orange-100 text-orange-700';

                const nombre = getField(s, 'nombre', 'Nombre') || 'An√≥nimo';
                const registro = getField(s, 'registro', 'Registro') || '-';
                const semestreRaw = getField(s, 'semestre', 'Semestre');

                tr.innerHTML = `
                    <td class="p-4">
                        <div class="font-bold text-slate-800">${nombre}</div>
                        <div class="text-xs text-slate-500 md:hidden">${registro}</div>
                    </td>
                    <td class="p-4 text-slate-600 hidden md:table-cell">${registro}</td>
                    <td class="p-4">
                        <div class="flex flex-wrap gap-1 max-w-[200px]">
                            ${formatListAsBadges(semestreRaw)}
                        </div>
                    </td>
                    <td class="p-4">${estadoBadge}</td>
                    <td class="p-4 hidden lg:table-cell">
                        <span class="px-2 py-1 rounded text-xs font-medium ${sentimentBadge}">${sentimiento}</span>
                    </td>
                    <td class="p-4 text-slate-600 text-sm">${aprobadas} mat.</td>
                    <td class="p-4 text-right text-slate-300 group-hover:text-blue-600 transition-colors">
                        <i class="fas fa-eye mr-2"></i>
                    </td>
                    <td class="p-4 text-center" onclick="event.stopPropagation()">
                        <button onclick="confirmDelete('${s.id}')" class="text-slate-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-full transition-all" title="Eliminar registro">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('total-count').innerText = allSurveys.length;
        }

        const chartInstances = {};

        function renderDashboard() {
            const countData = (fieldKeys) => {
                const counts = {};
                allSurveys.forEach(s => {
                    let val = getField(s, ...ensureArray(fieldKeys));

                    if(Array.isArray(val)) {
                        val.forEach(v => {
                            let label = v || "Sin respuesta";
                            counts[label] = (counts[label] || 0) + 1;
                        });
                    } else {
                        let label = val || "Sin respuesta";
                        if(label.length > 25) label = label.substring(0, 25) + "...";
                        counts[label] = (counts[label] || 0) + 1;
                    }
                });
                return counts;
            };
            
            const ensureArray = (v) => Array.isArray(v) ? v : [v];

            const renderChart = (canvasId, type, counts, label, colorHex) => {
                const canvas = document.getElementById(canvasId);
                if(!canvas) return;
                
                if(chartInstances[canvasId]) chartInstances[canvasId].destroy();

                const labels = Object.keys(counts);
                const data = Object.values(counts);
                let bgColors = colorHex;
                
                if(!Array.isArray(bgColors)) {
                    if (type === 'pie' || type === 'doughnut') {
                        bgColors = ['#1e3a8a', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
                    } else {
                        bgColors = colorHex;
                    }
                }

                chartInstances[canvasId] = new Chart(canvas, {
                    type: type,
                    data: {
                        labels: labels.length > 0 ? labels : ['Sin datos'],
                        datasets: [{
                            label: label,
                            data: data.length > 0 ? data : [0],
                            backgroundColor: bgColors,
                            borderWidth: 1
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        indexAxis: (type === 'bar' && (canvasId.includes('priority') || canvasId.includes('measures') || canvasId.includes('malla-status'))) ? 'y' : 'x',
                        plugins: { 
                            legend: { display: (type === 'pie' || type === 'doughnut'), position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } }
                        }
                    }
                });
            };

            // GR√ÅFICOS
            renderChart('chart-semestre', 'bar', countData(['semestre', 'Semestre']), 'Estudiantes', '#3b82f6');
            renderChart('chart-carga', 'bar', countData(['carga_academica', 'carga']), 'Estudiantes', '#0ea5e9');
            renderChart('chart-trabaja', 'pie', countData(['trabaja', 'Trabaja']), 'Estudiantes', null);
            renderChart('chart-horas', 'bar', countData(['horas_estudio', 'Horas_estudio', 'horas']), 'Estudiantes', '#6366f1');
            renderChart('chart-avance', 'doughnut', countData(['avance', 'Avance']), 'Estudiantes', null);

            renderChart('chart-p10', 'pie', countData('q10'), 'Respuestas', null);
            renderChart('chart-sentiment', 'bar', countData('q11'), 'Estudiantes', '#8b5cf6');
            renderChart('chart-p12', 'bar', countData('q12'), 'Estudiantes', '#f59e0b');
            renderChart('chart-measures', 'bar', countData('q13'), 'Votos', '#10b981');
            renderChart('chart-priority', 'bar', countData('prioridad'), 'Votos', '#ef4444');

            // Global Malla
            let mallaStats = { 'Aprobado': 0, 'Reprobado': 0, 'Pendiente/Otro': 0 };
            allSurveys.forEach(s => {
                if(s.malla && Array.isArray(s.malla)) {
                    s.malla.forEach(m => {
                        if(m.estado === 'aprobado') mallaStats['Aprobado']++;
                        else if(m.estado === 'reprobado') mallaStats['Reprobado']++;
                        else mallaStats['Pendiente/Otro']++;
                    });
                }
            });
            renderChart('chart-malla-status', 'bar', mallaStats, 'Materias', ['#22c55e', '#ef4444', '#cbd5e1']);
        }

        window.openStudentDetail = (student) => {
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('modal-content-body');

            const nombre = getField(student, 'nombre', 'Nombre') || '-';
            const apellidos = getField(student, 'Apellidos', 'apellidos') || getField(student, 'nombre', 'Nombre')?.split(' ').slice(1).join(' ') || '-';
            const ci = getField(student, 'CI', 'ci', 'Ci', 'carnet') || '<span class="text-red-400 italic">No registrado</span>'; 
            const registro = getField(student, 'registro', 'Registro') || '-';
            const celular = getField(student, 'celular', 'Celular') || '-';
            const correo = getField(student, 'correo', 'Correo') || '-';
            const semestre = getField(student, 'semestre', 'Semestre');
            const carga = getField(student, 'carga_academica', 'carga') || '-';
            const trabaja = getField(student, 'trabaja', 'Trabaja') || '-';
            const horas = getField(student, 'horas_estudio', 'Horas_estudio', 'horas') || '<span class="text-red-400 italic">No registrado</span>';
            const avance = getField(student, 'avance', 'Avance') || '<span class="text-red-400 italic">No registrado</span>';
            
            const p10_val = getField(student, 'q10') || '-';
            const p10_exp = getField(student.seccion2_cierre, 'explicacion') || '';
            const p11_val = getField(student, 'q11') || '-';
            const p12_val = getField(student, 'q12') || '-';
            const p12_otra = getField(student.seccion3, 'q12_otra') || '';
            const p13_val = getField(student, 'q13');
            const p13_otros = getField(student.seccion4, 'q13_otros') || '';
            const prioridad = getField(student, 'prioridad') || '-';
            const propuesta = getField(student, 'propuesta') || getField(student.seccion5, 'propuesta') || 'Sin comentarios.';

            let html = `
                <!-- TABS INTERNOS DEL MODAL -->
                <div class="flex border-b border-slate-200 mb-4 gap-2">
                    <button class="px-4 py-2 text-blue-900 font-bold border-b-2 border-blue-900 outline-none transition-colors rounded-t-lg hover:bg-blue-50" onclick="document.getElementById('tab-info').classList.remove('hidden'); document.getElementById('tab-raw').classList.add('hidden'); this.classList.add('border-blue-900', 'text-blue-900'); this.nextElementSibling.classList.remove('border-blue-900', 'text-blue-900'); this.nextElementSibling.classList.add('text-slate-500', 'border-transparent');">
                        <i class="fas fa-file-alt mr-1"></i> Informaci√≥n
                    </button>
                    <button class="px-4 py-2 text-slate-500 border-b-2 border-transparent hover:text-slate-800 outline-none transition-colors rounded-t-lg hover:bg-slate-100" onclick="document.getElementById('tab-info').classList.add('hidden'); document.getElementById('tab-raw').classList.remove('hidden'); this.classList.add('border-blue-900', 'text-blue-900'); this.classList.remove('text-slate-500', 'border-transparent'); this.previousElementSibling.classList.remove('border-blue-900', 'text-blue-900'); this.previousElementSibling.classList.add('text-slate-500', 'border-transparent');">
                        <i class="fas fa-code mr-1"></i> Datos Crudos (Debug)
                    </button>
                </div>

                <div id="tab-info">
                    <!-- SECCI√ìN 1: DATOS GENERALES (P1-P11) -->
                    <div class="bg-blue-50 p-5 rounded-xl mb-6 border border-blue-100 shadow-sm">
                        <h4 class="text-blue-900 font-bold mb-4 border-b border-blue-200 pb-2 flex items-center gap-2">
                            <i class="fas fa-id-card"></i> Datos Personales y Situaci√≥n (P1-P11)
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-y-4 gap-x-6 text-sm">
                            <!-- Personales 1-6 -->
                            <div><p class="text-xs text-slate-500 uppercase font-bold">1. Nombre</p><p class="font-medium text-slate-800">${nombre}</p></div>
                            <div><p class="text-xs text-slate-500 uppercase font-bold">2. Apellidos</p><p class="font-medium text-slate-800">${apellidos}</p></div>
                            <div><p class="text-xs text-slate-500 uppercase font-bold">3. C.I.</p><p class="font-medium text-slate-800">${ci}</p></div>
                            <div><p class="text-xs text-slate-500 uppercase font-bold">4. Registro</p><p class="font-medium text-slate-800">${registro}</p></div>
                            <div><p class="text-xs text-slate-500 uppercase font-bold">5. Celular</p><p class="font-medium text-slate-800">${celular}</p></div>
                            <div><p class="text-xs text-slate-500 uppercase font-bold">6. Correo</p><p class="font-medium text-slate-800">${correo}</p></div>
                            
                            <!-- Acad√©micos 7-11 -->
                            <div class="md:col-span-3 border-t border-blue-200 mt-2 pt-2"></div>
                            
                            <div class="md:col-span-2">
                                <p class="text-xs text-slate-500 uppercase font-bold mb-1">7. Semestre Actual</p>
                                <div class="flex flex-wrap gap-1">
                                    ${formatListAsBadges(semestre)}
                                </div>
                            </div>
                            <div><p class="text-xs text-slate-500 uppercase font-bold">8. Carga Acad√©mica</p><p class="font-medium text-slate-800">${carga}</p></div>
                            <div><p class="text-xs text-slate-500 uppercase font-bold">9. ¬øTrabaja?</p><p class="font-medium text-slate-800">${trabaja}</p></div>
                            <div><p class="text-xs text-slate-500 uppercase font-bold">10. Horas Estudio/D√≠a</p><p class="font-medium text-slate-800">${horas}</p></div>
                            <div><p class="text-xs text-slate-500 uppercase font-bold">11. Estado Avance</p><p class="font-medium text-slate-800">${avance}</p></div>
                        </div>
                    </div>

                    <!-- SECCI√ìN 2: AVANCE ACAD√âMICO (Malla + P12) -->
                    <div class="mb-6">
                        <h4 class="text-slate-800 font-bold mb-3 border-b pb-1 flex items-center gap-2"><i class="fas fa-chart-line"></i> Secci√≥n 2: Avance Acad√©mico</h4>
                        
                        <div class="bg-white border border-slate-200 p-4 rounded-lg mb-4 shadow-sm">
                            <p class="text-xs text-slate-500 uppercase font-bold mb-1">12. ¬øEstas materias afectan tu avance?</p>
                            <p class="text-blue-900 font-bold text-lg">${p10_val}</p>
                            ${p10_exp ? `<p class="text-slate-600 mt-2 text-sm italic bg-slate-50 p-2 rounded border border-slate-100">Explicaci√≥n: "${p10_exp}"</p>` : ''}
                        </div>

                        <div class="bg-slate-100 p-4 rounded-xl border border-slate-200 overflow-x-auto">
                            <p class="text-xs text-slate-500 uppercase font-bold mb-2">Malla Curricular Interactiva (Detalle)</p>
                            ${renderFullMalla(student.malla)}
                        </div>
                    </div>

                    <!-- SECCI√ìN 3: EXPECTATIVAS (P13-P14) -->
                    <div class="mb-6">
                        <h4 class="text-slate-800 font-bold mb-3 border-b pb-1 flex items-center gap-2"><i class="fas fa-lightbulb"></i> Secci√≥n 3: Expectativas</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white border border-slate-200 p-4 rounded-lg shadow-sm">
                                <p class="text-xs text-slate-500 uppercase font-bold mb-1">13. Sentimiento frente al cambio</p>
                                <p class="font-medium text-slate-800">${p11_val}</p>
                            </div>
                            <div class="bg-white border border-slate-200 p-4 rounded-lg shadow-sm">
                                <p class="text-xs text-slate-500 uppercase font-bold mb-1">14. Aporte del nuevo curr√≠culo</p>
                                <p class="font-medium text-slate-800">${p12_val}</p>
                                ${p12_otra ? `<p class="text-slate-500 text-xs mt-1 italic">Otro: "${p12_otra}"</p>` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- SECCI√ìN 4: MEDIDAS (P15-P16) -->
                    <div class="mb-6">
                        <h4 class="text-slate-800 font-bold mb-3 border-b pb-1 flex items-center gap-2"><i class="fas fa-tasks"></i> Secci√≥n 4: Medidas Preferidas</h4>
                        <div class="space-y-4">
                            <div class="bg-white border border-slate-200 p-4 rounded-lg shadow-sm">
                                <p class="text-xs text-slate-500 uppercase font-bold mb-1">15. Medidas √∫tiles (Selecci√≥n M√∫ltiple)</p>
                                <div class="flex flex-wrap gap-1 mt-1">
                                    ${formatListAsBadges(p13_val)}
                                </div>
                                ${p13_otros ? `<p class="text-slate-500 text-xs mt-2 italic border-t pt-1">Espec√≠fico: "${p13_otros}"</p>` : ''}
                            </div>

                            <div class="bg-white border border-slate-200 p-4 rounded-lg shadow-sm">
                                <p class="text-xs text-slate-500 uppercase font-bold mb-1">16. Prioridad Absoluta</p>
                                <div class="flex items-center gap-2">
                                    <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-sm font-bold"><i class="fas fa-star mr-1"></i> ${prioridad}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECCI√ìN 5: FINAL (P17) -->
                    <div class="bg-yellow-50 border border-yellow-200 p-5 rounded-xl shadow-sm">
                        <h4 class="text-yellow-900 font-bold mb-2 flex items-center gap-2"><i class="fas fa-comment-dots"></i> Secci√≥n 5: Comentarios Finales</h4>
                        <p class="text-xs text-yellow-800 uppercase font-bold mb-2">17. Propuesta para mejorar la transici√≥n</p>
                        <div class="bg-white p-4 rounded border border-yellow-100 italic text-slate-700 text-sm">
                            "${propuesta}"
                        </div>
                    </div>
                </div>

                <!-- TAB: RAW DATA (Debug) -->
                <div id="tab-raw" class="hidden">
                    <div class="bg-slate-900 text-green-400 p-4 rounded-lg font-mono text-xs overflow-auto max-h-96 shadow-inner border border-slate-700">
                        <pre>${JSON.stringify(student, null, 2)}</pre>
                    </div>
                    <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-800">
                        <p class="font-bold mb-1"><i class="fas fa-search"></i> Diagn√≥stico:</p>
                        <p>Si las preguntas 3, 7, 10 u 11 est√°n vac√≠as arriba pero APARECEN aqu√≠ abajo, es un error de visualizaci√≥n (av√≠sale al desarrollador).</p>
                        <p class="mt-1">Si NO APARECEN aqu√≠ abajo (ni como "CI", "horas_estudio", "avance", "semestre"), entonces <strong>no se guardaron en la base de datos</strong>. Revisa el c√≥digo de la encuesta.</p>
                    </div>
                </div>
            `;

            content.innerHTML = html;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        function renderFullMalla(mallaData) {
            if (!mallaData || mallaData.length === 0) return '<p class="text-center text-slate-400 italic py-4">No se registraron materias.</p>';
            
            const columns = {};
            for(let i=0; i<10; i++) columns[i] = [];
            
            mallaData.forEach(m => {
                if (m.id && m.id.startsWith("sem-")) {
                    const parts = m.id.split('-');
                    const colIndex = parseInt(parts[1]);
                    if (columns[colIndex]) columns[colIndex].push(m);
                } else if (m.id && (m.id.startsWith("elec-") || m.id.startsWith("taller-"))) {
                    if(!columns[10]) columns[10] = [];
                    columns[10].push(m);
                } else if (m.id && m.id.startsWith("mod")) {
                    if (m.id.startsWith("mod9-")) {
                        if (!columns[8]) columns[8] = [];
                        columns[8].push(m);
                    } else if (m.id.startsWith("mod10-")) {
                        if (!columns[9]) columns[9] = [];
                        columns[9].push(m);
                    }
                }
            });

            let html = '<div class="flex gap-2 overflow-x-auto pb-2" style="min-width: max-content;">';
            for (let i = 0; i <= 10; i++) {
                if (!columns[i] || columns[i].length === 0) continue; 
                let semTitle = (i < 10) ? `${i+1}¬∫ Sem` : "Elect/Tall";
                
                html += `<div class="flex flex-col gap-2 w-28 shrink-0">
                            <div class="text-center text-[10px] font-bold text-slate-400 uppercase border-b border-slate-300 pb-1 mb-1">${semTitle}</div>`;
                
                columns[i].forEach(m => {
                    let bgClass = "bg-white border-slate-200 text-slate-400";
                    let icon = "";
                    if (m.estado === 'aprobado') { 
                        bgClass = "bg-green-100 border-green-300 text-green-900 font-bold"; 
                        icon = '<i class="fas fa-check text-[10px] opacity-60"></i>';
                    } else if (m.estado === 'reprobado') { 
                        bgClass = "bg-red-100 border-red-300 text-red-900"; 
                        icon = '<i class="fas fa-times text-[10px] opacity-60"></i>';
                    } else if (m.estado === 'levantamiento') { 
                        bgClass = "bg-blue-100 border-blue-300 text-blue-900"; 
                        icon = '<i class="fas fa-arrow-up text-[10px] opacity-60"></i>';
                    }
                    html += `<div class="p-2 rounded border text-[10px] flex items-center justify-center text-center h-14 relative leading-tight ${bgClass}" title="${m.nombre}">
                                ${m.nombre}
                                <div class="absolute top-0.5 right-1">${icon}</div>
                             </div>`;
                });
                html += `</div>`;
            }
            html += '</div>';
            return html;
        }

        window.closeModal = () => {
            const modal = document.getElementById('detail-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        document.getElementById('detail-modal')?.addEventListener('click', (e) => {
            if (e.target === document.getElementById('detail-modal')) window.closeModal();
        });
        
        document.getElementById('delete-confirm-modal')?.addEventListener('click', (e) => {
            if (e.target === document.getElementById('delete-confirm-modal')) window.closeDeleteModal();
        });

        initAdmin();
    </script>
    </head>
    <body
        class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex flex-col font-sans">

        <!-- Header Admin -->
        <header
            class="bg-blue-900 text-white p-4 shadow-md flex justify-between items-center z-10 shrink-0">
            <div class="flex items-center gap-3">
                <div
                    class="bg-white p-1 rounded h-10 w-10 flex items-center justify-center text-blue-900 shadow">
                    <i class="fas fa-university text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold leading-tight">Panel de
                        Administraci√≥n</h1>
                    <p class="text-blue-200 text-xs">Resultados en Tiempo
                        Real</p>
                </div>
            </div>
            <div
                class="bg-blue-800 px-4 py-2 rounded-lg text-sm shadow-inner border border-blue-700">
                Total: <span id="total-count"
                    class="font-bold text-white text-lg ml-1">0</span>
            </div>
        </header>

        <!-- Navegaci√≥n de Pesta√±as -->
        <div class="bg-white border-b border-slate-200 px-4 pt-4 flex gap-6 z-10">
            <button onclick="switchTab('list')" id="tab-btn-list" class="pb-3 border-b-2 border-blue-900 text-blue-900 font-bold text-sm transition-colors flex items-center gap-2">
                <i class="fas fa-list"></i> Lista de Encuestas
            </button>
            <button onclick="switchTab('stats')" id="tab-btn-stats" class="pb-3 border-b-2 border-transparent text-slate-500 hover:text-slate-700 font-medium text-sm transition-colors flex items-center gap-2">
                <i class="fas fa-chart-pie"></i> Resumen Estad√≠stico
            </button>
        </div>

        <div class="flex flex-1 overflow-hidden relative">

            <!-- VISTA 1: Lista -->
            <main id="view-list" class="absolute inset-0 flex flex-col bg-slate-50">
                <!-- Barra superior -->
                <div
                    class="p-4 border-b border-slate-200 bg-white flex justify-between items-center shrink-0 shadow-sm">
                    <h2
                        class="font-bold text-slate-700 flex items-center gap-2"><i
                            class="fas fa-users text-blue-900"></i> Lista de
                        Encuestas</h2>
                    <button onclick="initAdmin()"
                        class="text-blue-600 hover:text-blue-800 text-sm flex items-center gap-1 transition-colors px-3 py-1 rounded hover:bg-blue-50">
                        <i class="fas fa-sync-alt"></i> Actualizar Datos
                    </button>
                </div>

                <!-- Estado de Conexi√≥n -->
                <div id="connection-status" class="px-6 pt-4 shrink-0">
                </div>

                <!-- Tabla -->
                <div class="flex-1 overflow-auto p-4 md:p-6">
                    <div
                        class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left border-collapse">
                            <thead
                                class="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500 font-semibold tracking-wider sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="p-4">Estudiante</th>
                                    <th
                                        class="p-4 hidden md:table-cell">Registro</th>
                                    <th class="p-4">Semestre</th>
                                    <th
                                        class="p-4 hidden lg:table-cell">Estado</th>
                                    <th class="p-4 hidden lg:table-cell">Sentimiento</th>
                                    <th class="p-4">Materias</th>
                                    <th class="p-4 text-right">Ver</th>
                                    <th class="p-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="students-table-body"
                                class="text-sm divide-y divide-slate-100 bg-white">
                                <tr>
                                    <td colspan="7" class="p-8 text-center">
                                        <i
                                            class="fas fa-spinner fa-spin text-blue-900 text-2xl"></i>
                                        <p
                                            class="text-slate-500 mt-2">Cargando...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <p
                        class="text-center text-xs text-slate-400 mt-4 mb-2">Mostrando
                        registros m√°s recientes primero.</p>
                </div>
            </main>

            <!-- VISTA 2: Resumen Estad√≠stico -->
            <div id="view-stats" class="absolute inset-0 overflow-y-auto bg-slate-50 p-6 hidden">
                <div class="max-w-7xl mx-auto">
                    <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <i class="fas fa-chart-bar text-blue-900"></i> Dashboard de Resultados Globales
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        
                        <!-- P7. Semestre -->
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                             <h4 class="font-bold text-slate-700 mb-3 text-center uppercase text-xs tracking-wider">P7. Semestre Actual</h4>
                             <div class="h-60 relative"><canvas id="chart-semestre"></canvas></div>
                        </div>

                        <!-- P8. Carga -->
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                             <h4 class="font-bold text-slate-700 mb-3 text-center uppercase text-xs tracking-wider">P8. Carga Acad√©mica</h4>
                             <div class="h-60 relative"><canvas id="chart-carga"></canvas></div>
                        </div>

                        <!-- P9. Trabaja -->
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                             <h4 class="font-bold text-slate-700 mb-3 text-center uppercase text-xs tracking-wider">P9. Situaci√≥n Laboral</h4>
                             <div class="h-60 relative"><canvas id="chart-trabaja"></canvas></div>
                        </div>

                        <!-- P10. Horas Estudio (NUEVO) -->
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                             <h4 class="font-bold text-slate-700 mb-3 text-center uppercase text-xs tracking-wider">P10. Horas Estudio/D√≠a</h4>
                             <div class="h-60 relative"><canvas id="chart-horas"></canvas></div>
                        </div>

                        <!-- P11. Avance -->
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                             <h4 class="font-bold text-slate-700 mb-3 text-center uppercase text-xs tracking-wider">P11. Autopercepci√≥n Avance</h4>
                             <div class="h-60 relative"><canvas id="chart-avance"></canvas></div>
                        </div>

                        <!-- P12. Afectaci√≥n -->
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                             <h4 class="font-bold text-slate-700 mb-3 text-center uppercase text-xs tracking-wider">P12. ¬øAfectaci√≥n por Malla?</h4>
                             <div class="h-60 relative"><canvas id="chart-p10"></canvas></div>
                        </div>

                        <!-- P13. Sentimiento -->
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                             <h4 class="font-bold text-slate-700 mb-3 text-center uppercase text-xs tracking-wider">P13. Sentimiento</h4>
                             <div class="h-60 relative"><canvas id="chart-sentiment"></canvas></div>
                        </div>

                        <!-- P14. Aporte -->
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                             <h4 class="font-bold text-slate-700 mb-3 text-center uppercase text-xs tracking-wider">P14. Aporte Esperado</h4>
                             <div class="h-60 relative"><canvas id="chart-p12"></canvas></div>
                        </div>
                        
                        <!-- P15. Medidas -->
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 lg:col-span-2">
                             <h4 class="font-bold text-slate-700 mb-3 text-center uppercase text-xs tracking-wider">P15. Medidas de Apoyo</h4>
                             <div class="h-60 relative"><canvas id="chart-measures"></canvas></div>
                        </div>

                        <!-- Malla Global -->
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                             <h4 class="font-bold text-slate-700 mb-3 text-center uppercase text-xs tracking-wider">Estado Global de Materias</h4>
                             <div class="h-60 relative"><canvas id="chart-malla-status"></canvas></div>
                        </div>

                        <!-- P16. Prioridad -->
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 md:col-span-2 lg:col-span-3">
                             <h4 class="font-bold text-slate-700 mb-3 text-center uppercase text-xs tracking-wider">P16. Prioridad Principal</h4>
                             <div class="h-72 relative"><canvas id="chart-priority"></canvas></div>
                        </div>

                    </div>
                    <div class="h-10"></div>
                </div>
            </div>

        </div>

        <!-- Modal Detalle -->
        <div id="detail-modal"
            class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm hidden z-50 items-center justify-center p-4 transition-opacity duration-300">
            <div
                class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform transition-all scale-100 border border-slate-200">
                <!-- Modal Header -->
                <div
                    class="p-4 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-xl sticky top-0 z-10 shadow-sm">
                    <h3
                        class="font-bold text-lg text-slate-800 flex items-center gap-2">
                        <span
                            class="bg-blue-100 text-blue-800 p-2 rounded-full h-8 w-8 flex items-center justify-center"><i
                                class="fas fa-user-graduate text-sm"></i></span>
                        Reporte Individual de Estudiante
                    </h3>
                    <button onclick="closeModal()"
                        class="text-slate-400 hover:text-red-500 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Modal Body -->
                <div id="modal-content-body"
                    class="p-6 overflow-y-auto bg-slate-50 custom-scrollbar">
                    <!-- Contenido inyectado por JS -->
                </div>

                <!-- Modal Footer -->
                <div
                    class="p-4 border-t border-slate-100 bg-white rounded-b-xl flex justify-end shrink-0">
                    <button onclick="closeModal()"
                        class="px-6 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium text-sm shadow-sm transition-all hover:shadow-md">
                        Cerrar Reporte
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Confirmaci√≥n Eliminaci√≥n -->
        <div id="delete-confirm-modal" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm hidden z-50 items-center justify-center p-4 transition-opacity duration-300">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100 border border-slate-200">
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg leading-6 font-medium text-slate-900 mb-2">¬øEliminar encuesta?</h3>
                    <p class="text-sm text-slate-500 mb-6">
                        Esta acci√≥n borrar√° permanentemente el registro de la base de datos. No se puede deshacer.
                    </p>
                    <div class="flex gap-3 justify-center">
                        <button onclick="window.closeDeleteModal()" class="px-4 py-2 bg-white text-slate-700 border border-slate-300 rounded-lg hover:bg-slate-50 font-medium text-sm transition-colors">
                            Cancelar
                        </button>
                        <button id="btn-confirm-delete" onclick="window.executeDelete()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium text-sm transition-colors shadow-sm flex items-center gap-2">
                            <i class="fas fa-trash-alt text-xs"></i> S√≠, eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
