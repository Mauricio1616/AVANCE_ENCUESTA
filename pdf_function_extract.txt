function descargarReportePDF() {
    console.log(' INICIANDO DESCARGA DE PDF...');

    // 1. Determinar fuente de datos: Â¿Nueva encuesta o Datos cargados de Firebase?
    let allData;
    if (window.existingSurveyData) {
        console.log(' Usando datos existentes cargados desde Firebase');
        allData = window.existingSurveyData;
    } else {
        console.log(' Usando datos de la sesiÃ³n actual');
        allData = capturarTodosDatos();
    }

    const data = allData.personal || {};
    const malla = allData.malla || [];
    const seccion2_cierre = allData.seccion2_cierre || {};
    const seccion3 = allData.seccion3 || {};
    const seccion4 = allData.seccion4 || {};
    const seccion5 = allData.seccion5 || {};

    console.log(' Datos para PDF listos:', allData);

    const nombre = data.nombre || '-';
    const apellidos = data.apellidos || '-';
    const registro = data.registro || '-';
    const ci = data.CI || '-';
    const celular = data.celular || '-';
    const correo = data.correo || '-';

    // Validar si semestre es array o string
    let semestreStr = '-';
    if (Array.isArray(data.semestre)) {
        semestreStr = data.semestre.join(', ');
    } else if (data.semestre) {
        semestreStr = data.semestre;
    }

    // Datos acadÃ©micos
    const anioIngreso = data.anio_ingreso || '-';
    const modalidadIngreso = data.modalidad_ingreso || '-';
    const tiempoTerminar = data.tiempo_terminar || '-';
    const ppa = data.ppa || '-';
    const carga = data.carga_academica || '-';
    const matAprob = data.materias_aprobadas || '-';
    const matReprob = data.materias_reprobadas || '-';
    const repitio = data.repetido_materia || '-';
    // Si repitiÃ³, mostrar cuÃ¡les
    const repitioCual = (repitio === 'SÃ­' && data.materias_repetidas_nombres)
        ? `(${data.materias_repetidas_nombres})`
        : '';
    const matDificultad = data.materias_dificultad || 'Ninguna especificada';

    // NUEVO P17
    let veranoAprob = '-';
    if (data.materias_verano_aprobadas && data.materias_verano_aprobadas.length > 0) {
        veranoAprob = data.materias_verano_aprobadas.join(', ');
    }
    let veranoReprob = '-';
    if (data.materias_verano_reprobadas && data.materias_verano_reprobadas.length > 0) {
        veranoReprob = data.materias_verano_reprobadas.join(', ');
    }

    // Datos laborales
    const trabaja = data.trabaja || '-';
    const horas = data.horas_estudio || '-';
    const avance = data.avance || '-';

    // Preguntas
    const p10 = seccion2_cierre.q10 || '-';
    const p10Exp = (seccion2_cierre.q10 === 'Depende' && seccion2_cierre.explicacion)
        ? `(Por: ${seccion2_cierre.explicacion})`
        : '';

    const p11 = seccion3.q11 || '-';

    let p12 = seccion3.q12 || '-';
    if ((p12 === 'Otra' || p12 === 'otra') && seccion3.q12_otra) {
        p12 = seccion3.q12_otra;
    }

    let p13 = '-';
    if (Array.isArray(seccion4.q13)) {
        p13 = seccion4.q13.join(', ');
        if (seccion4.q13.includes('Otros') && seccion4.q13_otros) {
            p13 += ` (${seccion4.q13_otros})`;
        }
    } else if (seccion4.q13) {
        p13 = seccion4.q13;
    }

    const prioridad = seccion4.prioridad || '-';
    const propuesta = seccion5.propuesta || 'Sin comentarios.';

    // --- LÃ“GICA DE VISUALIZACIÃ“N TIPO ADMIN PANEL (Malla Horizontal COMPLETA) ---

    // 1. Definir la estructura base estÃ¡tica (Todos los semestres)
    // Usamos las variables globales semesterData, electivasData, talleresData definidas al inicio del script

    // Preparar columnas
    const columns = {};
    for (let i = 0; i <= 10; i++) columns[i] = [];

    // Detectar modalidad del usuario para semestres 9 y 10
    // Buscamos en los datos guardados si hay alguna materia de 9no/10mo para inferir la modalidad
    let userModality = 'humanista'; // Default
    const modalityMatch = malla.find(m => m.id && m.id.includes('mod9-'));
    if (modalityMatch) {
        const parts = modalityMatch.id.split('-');
        if (parts.length >= 2) userModality = parts[1];
    }
    console.log("Modalidad detectada para PDF:", userModality);

    // 2. Llenar columnas con datos ESTÃTICOS (La malla vacÃ­a completa)

    // Semestres 1-8 (ndices 0-7)
    for (let i = 0; i <= 7; i++) {
        const semInfo = semesterData[i]; // { title: "...", subjects: [...] }
        if (semInfo && semInfo.subjects) {
            semInfo.subjects.forEach((subjName, idx) => {
                // ID teÃ³rico para bÃºsqueda
                const staticId = `sem-${i}-${idx}`;
                columns[i].push({ id: staticId, nombre: subjName, estado: 'pendiente' }); // Estado default
            });
        }
    }

    // Semestres 9-10 (ndices 8-9) - Dependen de la modalidad
    // Usamos abordajesData global
    const abordaje = abordajesData[userModality] || abordajesData['humanista'];

    // Semestre 9
    // Materia comÃºn S9 (Ã‰tica I)
    if (semesterData[8] && semesterData[8].subjects) {
        semesterData[8].subjects.forEach((subjName, idx) => {
            columns[8].push({ id: `sem-8-${idx}`, nombre: subjName, estado: 'pendiente' });
        });
    }
    // Materias de modalidad S9
    if (abordaje && abordaje.sem9) {
        abordaje.sem9.forEach((subj, idx) => {
            columns[8].push({ id: `mod9-${userModality}-${idx}`, nombre: subj.name, estado: 'pendiente' });
        });
    }

    // Semestre 10
    // Materia comÃºn S10 (Ã‰tica II)
    if (semesterData[9] && semesterData[9].subjects) {
        semesterData[9].subjects.forEach((subjName, idx) => {
            columns[9].push({ id: `sem-9-${idx}`, nombre: subjName, estado: 'pendiente' });
        });
    }
    // Materias de modalidad S10
    if (abordaje && abordaje.sem10) {
        abordaje.sem10.forEach((subj, idx) => {
            columns[9].push({ id: `mod10-${userModality}-${idx}`, nombre: subj.name, estado: 'pendiente' });
        });
    }

    // Electivas y Talleres (Columna 10)
    // Electivas
    electivasData.forEach((subjName, idx) => {
        columns[10].push({ id: `elec-${idx}`, nombre: subjName, estado: 'pendiente' });
    });
    // Talleres
    talleresData.forEach((subjName, idx) => {
        columns[10].push({ id: `taller-${idx}`, nombre: subjName, estado: 'pendiente' });
    });


    // 3. SOBRESCRIBIR con el estado real del usuario
    // Recorremos la 'malla' del usuario y actualizamos el estado en 'columns'
    malla.forEach(userSubj => {
        if (!userSubj.id) return;

        // Buscar esta materia en nuestra estructura estÃ¡tica 'columns'
        // Lo hacemos buscando por ID

        let found = false;
        // BÃºsqueda ineficiente pero segura (son pocos datos)
        for (let c = 0; c <= 10; c++) {
            const matchIndex = columns[c].findIndex(staticSubj => staticSubj.id === userSubj.id);
            if (matchIndex !== -1) {
                columns[c][matchIndex].estado = userSubj.estado;
                found = true;
                break;
            }
        }
    });


    // 4. GENERAR HTML (VisualizaciÃ³n)

    // Colores exactos del Admin Panel adaptados a estilos inline
    const stylesMap = {
        aprobado: { bg: '#dcfce7', text: '#14532d', border: '#86efac', icon: '' },
        reprobado: { bg: '#fee2e2', text: '#7f1d1d', border: '#fca5a5', icon: '' },
        levantamiento: { bg: '#e0f2fe', text: '#0c4a6e', border: '#7dd3fc', icon: '' },
        pendiente: { bg: '#ffffff', text: '#94a3b8', border: '#e2e8f0', icon: '' }
    };

    let mallaHTML = `<div style="display: flex; gap: 4px; overflow-x: visible; width: 100%; justify-content: space-between;">`;

    for (let i = 0; i <= 10; i++) {
        // Omitir columnas vacÃ­as si se desea, pero para estructura constante mejor mostrar 1-10 siempre
        // Aunque el admin panel muestra 10 + extras. Si la 10 (extras) estÃ¡ vacÃ­a, podrÃ­amos saltarla.
        if (i === 10 && columns[i].length === 0) continue;

        let semTitle = (i < 10) ? `${i + 1}Âº` : "E/T";

        mallaHTML += `<div style="display: flex; flex-direction: column; gap: 3px; width: 8.5%; min-width: 45px;">
            <div style="text-align: center; font-size: 8px; font-weight: bold; color: #94a3b8; text-transform: uppercase; border-bottom: 1px solid #cbd5e1; padding-bottom: 2px; margin-bottom: 2px;">${semTitle}</div>`;

        columns[i].forEach(m => {
            const st = stylesMap[m.estado] || stylesMap.pendiente;

            // Determine Name to Display
            let displayName = m.nombre;
            // Si el usuario tiene una selecciÃ³n personalizada, la usamos
            const userSubj = malla.find(u => u.id === m.id);
            if (userSubj && userSubj.customSelection) {
                // Formatting: "Original: Selected" or just "Selected" depending on length
                // User prefers to see what they selected.
                displayName = userSubj.customSelection;
            }

            // Recortar nombre si es muy largo
            let shortName = displayName;
            if (shortName.length > 25) {
                shortName = shortName.substring(0, 23) + '..'; // Increased limit slightly
            }

            // Adjustment for tiny font if still too long or custom
            const fontSize = (displayName.length > 20) ? '6px' : '7px';

            mallaHTML += `<div style="
                background-color: ${st.bg};
                color: ${st.text};
                border: 1px solid ${st.border};
                border-radius: 3px;
                padding: 2px;
                font-size: ${fontSize};
                line-height: 1.1;
                text-align: center;
                height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
                overflow: hidden;
                word-break: break-all; 
            " title="${displayName} (${m.estado})">
                ${shortName}
                ${st.icon ? `<div style="position: absolute; top: 0px; right: 1px; font-size: 6px; opacity: 0.7;">${st.icon}</div>` : ''}
            </div>`;
        });

        if (columns[i].length === 0) {
            mallaHTML += `<div style="text-align:center; color:#cbd5e1; font-size:7px; font-style:italic; padding-top:5px;">-</div>`;
        }

        mallaHTML += `</div>`;
    }
    mallaHTML += `</div>`;

    const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap');
            body { font-family: 'Roboto', Arial, sans-serif; margin: 0; padding: 20px; color: #1f2937; background: #fff; max-width: 800px; mx-auto; }
            
            /* Header */
            .header-container { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #1e3a8a; padding-bottom: 15px; margin-bottom: 25px; }
            .header-logo img { height: 60px; widht: auto; } 
            .header-text { text-align: right; }
            .header-title { font-size: 22px; font-weight: 800; color: #1e3a8a; margin: 0; letter-spacing: -0.5px; text-transform: uppercase; }
            .header-sub { font-size: 12px; color: #6b7280; font-weight: 500; margin-top: 5px; }
            
            /* Sections */
            .section { margin-bottom: 25px; background: #fff; }
            .section-header { background: #f1f5f9; color: #0f172a; padding: 8px 12px; font-size: 13px; font-weight: 800; border-left: 5px solid #1e3a8a; text-transform: uppercase; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; }
            
            /* Grids */
            .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
            .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
            
            /* Data Fields */
            .field-box { margin-bottom: 8px; }
            .label { font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
            .value { font-size: 12px; font-weight: 500; color: #111827; border-bottom: 1px solid #e5e7eb; padding-bottom: 2px; min-height: 16px; }
            .value-highlight { color: #1e3a8a; font-weight: 800; }
            
            /* Legend */
            .legend { display: flex; gap: 15px; justify-content: flex-end; margin-bottom: 10px; font-size: 10px; }
            .legend-item { display: flex; align-items: center; gap: 4px; }
            .dot { width: 10px; height: 10px; border-radius: 50%; }
            
            /* Footer */
            .footer { margin-top: 40px; text-align: center; color: #9ca3af; font-size: 9px; border-top: 1px solid #f3f4f6; padding-top: 15px; }
            
            /* Propuesta text area look */
            .propuesta-box { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; font-size: 12px; line-height: 1.5; color: #374151; font-style: italic; }
            
            /* Page break safety */
            .keep-together { break-inside: avoid; }
        </style>
    </head>
    <body>

        <!-- Header -->
        <div class="header-container">
            <div class="header-logo">
                 <!-- PodrÃ­as poner base64 del logo aquÃ­ si quisieras, por ahora texto estilizado o placeholder si no carga img externa -->
                 <img style="width: 150px; height: auto;" src="img/Encabezado.png" alt="Logo" class="object-contain bg-white rounded p-1 shadow-sm">
            </div>
            <div class="header-text">
                <h1 class="header-title">Reporte de SituaciÃ³n AcadÃ©mica</h1>
                <p class="header-sub">Proceso de transiciÃ³n curricular - Carrera de PsicologÃ­a</p>
                <p class="header-sub">Generado: ${new Date().toLocaleDateString('es-ES')} | REGISTRO: ${registro}</p>
            </div>
        </div>

        <!-- Section 1: Personal -->
        <div class="section keep-together">
            <div class="section-header"><span></span> Datos Personales y AcadÃ©micos</div>
            
            <div class="grid-3">
                <div class="field-box">
                    <div class="label">Registro Universitario</div>
                    <div class="value value-highlight">${registro}</div>
                </div>
                <div class="field-box">
                    <div class="label">CÃ©dula de Identidad</div>
                    <div class="value">${ci}</div>
                </div>
                <div class="field-box">
                    <div class="label">Nombre Completo</div>
                    <div class="value">${nombre} ${apellidos}</div>
                </div>
            </div>
            
            <div class="grid-3">
                <div class="field-box">
                    <div class="label">Semestre Actual</div>
                    <div class="value">${semestreStr}</div>
                </div>
                 <div class="field-box">
                    <div class="label">Carga Actual</div>
                    <div class="value">${carga} Materias</div>
                </div>
                <div class="field-box">
                    <div class="label">Contacto</div>
                    <div class="value">${celular}</div>
                </div>
            </div>

            <div class="grid-2">
                 <div class="field-box">
                    <div class="label">Correo ElectrÃ³nico</div>
                    <div class="value" style="font-size:11px;">${correo}</div>
                </div>
                 <div class="field-box">
                    <div class="label">AÃ±o de Ingreso / Modalidad</div>
                    <div class="value">${anioIngreso} - ${modalidadIngreso}</div>
                </div>
            </div>
        </div>

        <!-- Section 2: Historial -->
        <div class="section keep-together">
            <div class="section-header"><span></span> Historial y Rendimiento</div>
            <div class="grid-3">
                <div class="field-box">
                    <div class="label">PPA Aprox.</div>
                    <div class="value" style="color:#6b21a8; font-weight:700;">${ppa}</div>
                </div>
                <div class="field-box">
                    <div class="label">Mat. Aprobadas</div>
                    <div class="value" style="color:#059669; font-weight:700;">${matAprob}</div>
                </div>
                <div class="field-box">
                    <div class="label">Mat. Reprobadas</div>
                    <div class="value" style="color:#dc2626; font-weight:700;">${matReprob}</div>
                </div>
            </div>
            <div class="grid-2">
                <div class="field-box">
                    <div class="label">Tiempo Estimado FinalizacÃ³n</div>
                    <div class="value">${tiempoTerminar}</div>
                </div>
                <div class="field-box">
                    <div class="label">Repitencia (>3 veces)</div>
                    <div class="value">${repitio} ${repitioCual}</div>
                </div>
            </div>
            <div class="field-box" style="margin-bottom:12px;">
                <div class="label">Materias con Dificultad</div>
                <div class="value">${matDificultad}</div>
            </div>
            
            <!-- NUEVO BLOQUE P17 -->
            <div class="field-box" style="margin-bottom:12px; background-color:#eff6ff; padding:8px; border-radius:4px;">
                <div class="label" style="color:#1e3a8a;">MATERIAS PARA NIVELACIÃ“N / VERANO (YA APROBADAS)</div>
                <div class="value" style="border:none; padding-bottom:0;">${veranoAprob}</div>
            </div>
            <div class="field-box" style="margin-bottom:12px; background-color:#fef2f2; padding:8px; border-radius:4px;">
                <div class="label" style="color:#b91c1c;">MATERIAS PARA NIVELACIÃ“N / VERANO (REPROBADAS)</div>
                <div class="value" style="border:none; padding-bottom:0;">${veranoReprob}</div>
            </div>

            <div class="grid-2">
                 <div class="field-box">
                    <div class="label">SituaciÃ³n Laboral</div>
                    <div class="value">Trabaja: ${trabaja}</div>
                </div>
                 <div class="field-box">
                    <div class="label">Horas Estudio/DÃ­a</div>
                    <div class="value">${horas} Horas</div>
                </div>
            </div>
        </div>

        <!-- Section 3: Malla -->
        <div class="section">
            <div class="section-header">
                <div><span></span> Mapa de Avance Curricular</div>
            </div>
            
            <div class="legend">
                <div class="legend-item"><div class="dot" style="background:#34d399;"></div> Aprobado</div>
                <div class="legend-item"><div class="dot" style="background:#f87171;"></div> Reprobado</div>
                <div class="legend-item"><div class="dot" style="background:#38bdf8;"></div> Levantamiento</div>
                <div class="legend-item"><div class="dot" style="background:#d1d5db;"></div> Pendiente</div>
            </div>

            ${mallaHTML}
        </div>

        <!-- Section 4: Expectativas -->
        <div class="section keep-together">
             <div class="section-header"><span></span> PercepciÃ³n y Expectativas</div>
             
             <div class="field-box">
                <div class="label">Â¿CÃ³mo te sientes respecto al nuevo currÃ­culo?</div>
                <div class="value">${p11}</div>
             </div>
             
             <div class="grid-2">
                 <div class="field-box">
                    <div class="label">AfectaciÃ³n perceived</div>
                    <div class="value">${p10} ${p10Exp}</div>
                 </div>
                  <div class="field-box">
                    <div class="label">Aporte principal esperado</div>
                    <div class="value">${p12}</div>
                 </div>
             </div>
        </div>

        <!-- Section 5: Medidas -->
        <div class="section keep-together">
             <div class="section-header"><span></span> Medidas de TransiciÃ³n Preferidas</div>
             
             <div class="field-box">
                <div class="label">Medidas seleccionadas</div>
                <div class="value" style="line-height:1.4;">${p13}</div>
             </div>
             
             <div class="field-box" style="margin-top:10px;">
                <div class="label">PRIORIDAD ABSOLUTA</div>
                <div class="value value-highlight">${prioridad}</div>
             </div>
        </div>

        <!-- Section 6: Propuesta -->
        <div class="section keep-together">
             <div class="section-header"><span>Â¡</span> Tu Propuesta / Comentario Final</div>
             <div class="propuesta-box">
                "${propuesta}"
             </div>
        </div>

        <div class="footer">
            Documento generado automÃ¡ticamente por el Sistema de Encuestas Curriculares - PsicologÃ­a UAGRM<br>
            Este reporte es informativo y refleja las respuestas proporcionadas por el estudiante en la fecha indicada.
        </div>
    </body>
    </html>
    `;

    // ConfiguraciÃ³n PDF mejorada
    const element = document.createElement('div');
    element.innerHTML = htmlContent;

    const opt = {
        margin: [10, 10, 10, 10], // top, left, bottom, right
        filename: `Reporte_Psicologia_${registro}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
            scale: 2, // Mayor escala para nitidez
            useCORS: true,
            logging: false,
            letterRendering: true
        },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } // Evitar cortes feos
    };

    console.log('Generando PDF...');

    // Usar Worker si estÃ¡ disponible (html2pdf lo maneja)
    html2pdf().set(opt).from(element).save()
        .then(() => {
            console.log(' PDF Generado con Ã©xito!');
        })
        .catch(err => {
            console.error('Error generando PDF:', err);
            alert('Hubo un error generando el reporte. Por favor intente de nuevo.');
        });
}
